<html lang="de">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>ZfP Operator Audit - Schaeffler</title>
<style>
* {
box-sizing: border-box;
margin: 0;
padding: 0;
}
body {
font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
line-height: 1.4;
color: #333;
background-color: #f5f5f5;
padding: 6px;
font-size: 14px;
}
.container {
max-width: 1200px;
margin: 0 auto;
background: white;
padding: 10px;
border-radius: 6px;
box-shadow: 0 2px 8px rgba(0,0,0,0.1);
}
header {
text-align: center;
margin-bottom: 12px;
padding-bottom: 8px;
border-bottom: 2px solid #2c3e50;
}
h1 {
color: #2c3e50;
margin-bottom: 4px;
font-size: 2em;
}
.subtitle {
color: #7f8c8d;
font-size: 0.9em;
margin-bottom: 8px;
}

/* MODAL F√úR IPHONE FIX */
.custom-modal {
display: none;
position: fixed;
top: 0;
left: 0;
width: 100%;
height: 100%;
background: rgba(0,0,0,0.7);
z-index: 2000;
align-items: center;
justify-content: center;
}
.custom-modal-content {
background: white;
padding: 20px;
border-radius: 8px;
max-width: 90%;
width: 400px;
box-shadow: 0 4px 20px rgba(0,0,0,0.3);
text-align: center;
}
.custom-modal-buttons {
display: flex;
gap: 10px;
margin-top: 20px;
justify-content: center;
}
.custom-modal-btn {
padding: 8px 15px;
border: none;
border-radius: 4px;
cursor: pointer;
font-weight: bold;
min-width: 80px;
}
.custom-modal-btn.confirm {
background: #27ae60;
color: white;
}
.custom-modal-btn.cancel {
background: #e74c3c;
color: white;
}

/* MITARBEITER MODAL */
.employee-modal {
display: none;
position: fixed;
top: 0;
left: 0;
width: 100%;
height: 100%;
background: rgba(0,0,0,0.7);
z-index: 2000;
align-items: center;
justify-content: center;
}
.employee-modal-content {
background: white;
padding: 20px;
border-radius: 8px;
max-width: 90%;
width: 500px;
max-height: 80vh;
overflow-y: auto;
box-shadow: 0 4px 20px rgba(0,0,0,0.3);
}
.employee-modal h3 {
margin-bottom: 15px;
color: #2c3e50;
text-align: center;
font-weight: 700;
}
.employee-form {
max-height: 400px;
overflow-y: auto;
padding-right: 10px;
margin-bottom: 15px;
}
.employee-form-group {
margin-bottom: 10px;
}
.employee-form-group label {
display: block;
margin-bottom: 5px;
font-weight: 600;
color: #2c3e50;
font-size: 0.9em;
}
.employee-form-group input,
.employee-form-group select,
.employee-form-group textarea {
width: 100%;
padding: 8px;
border: 1px solid #ddd;
border-radius: 4px;
font-size: 0.9em;
font-family: inherit;
}
.employee-modal-buttons {
display: flex;
gap: 10px;
justify-content: flex-end;
margin-top: 20px;
position: sticky;
bottom: 0;
background: white;
padding-top: 15px;
}

/* AUDIT LISTE MODAL */
.audit-list-modal {
display: none;
position: fixed;
top: 0;
left: 0;
width: 100%;
height: 100%;
background: rgba(0,0,0,0.7);
z-index: 2000;
align-items: center;
justify-content: center;
}
.audit-list-content {
background: white;
padding: 20px;
border-radius: 8px;
max-width: 90%;
width: 700px;
max-height: 80vh;
overflow-y: auto;
box-shadow: 0 4px 20px rgba(0,0,0,0.3);
}
.audit-list-content h3 {
margin-bottom: 15px;
color: #2c3e50;
text-align: center;
font-weight: 700;
}
.audit-item {
border: 1px solid #ddd;
border-radius: 4px;
padding: 12px;
margin-bottom: 10px;
background: #f9f9f9;
}
.audit-item.has-deviations {
background: #fff0f0;
border-color: #e74c3c;
}
.audit-item-header {
display: flex;
justify-content: space-between;
align-items: center;
margin-bottom: 8px;
}
.audit-item-title {
font-weight: bold;
font-size: 1em;
}
.audit-item-date {
color: #666;
font-size: 0.85em;
}
.audit-item-details {
font-size: 0.85em;
margin-bottom: 8px;
}
.audit-item-deviations {
color: #e74c3c;
font-weight: bold;
margin-top: 5px;
}
.audit-item-actions {
display: flex;
gap: 8px;
margin-top: 8px;
}
.mark-reviewed-btn {
padding: 4px 8px;
background: #3498db;
color: white;
border: none;
border-radius: 3px;
cursor: pointer;
font-size: 0.8em;
}
.mark-reviewed-btn.reviewed {
background: #27ae60;
}
.no-audits-message {
text-align: center;
padding: 20px;
color: #666;
font-style: italic;
}

/* AUDIT AUSWAHL */
.audit-selection {
text-align: center;
margin: 15px 0;
}
.audit-selection h2 {
color: #2c3e50;
margin-bottom: 12px;
font-size: 1.1em;
font-weight: 700;
}
.audit-buttons {
display: grid;
grid-template-columns: repeat(auto-fit, minmax(150px, 1fr));
gap: 8px;
margin-bottom: 15px;
}
.audit-btn {
padding: 12px 8px;
background: #3498db;
color: white;
border: none;
border-radius: 5px;
cursor: pointer;
font-size: 0.95em;
font-weight: bold;
transition: all 0.2s;
display: flex;
flex-direction: column;
align-items: center;
justify-content: center;
min-height: 80px;
}
.audit-btn:hover {
transform: translateY(-2px);
box-shadow: 0 3px 6px rgba(0,0,0,0.2);
}
.audit-btn.wirbelstrom { background: #3498db; }
.audit-btn.magnetpulver { background: #e74c3c; }
.audit-btn.nital { background: #2ecc71; }
.audit-btn.ultraschall { background: #9b59b6; }
.audit-btn .btn-icon {
font-size: 1.6em;
margin-bottom: 6px;
}
.audit-btn .btn-progress {
margin-top: 4px;
font-size: 0.7em;
background: rgba(255,255,255,0.2);
padding: 2px 6px;
border-radius: 8px;
min-width: 35px;
}
.audit-btn.disabled {
opacity: 0.6;
cursor: not-allowed;
}
.audit-btn.disabled:hover {
transform: none;
box-shadow: none;
}

/* MITARBEITERLISTE BUTTON */
.employee-list-btn {
background: linear-gradient(135deg, #f39c12, #e67e22) !important;
color: white;
min-height: 70px;
font-size: 1.1em;
border: none;
box-shadow: 0 4px 8px rgba(243, 156, 18, 0.3);
margin-top: 15px;
width: 100%;
max-width: 400px;
margin-left: auto;
margin-right: auto;
display: block;
}
.employee-list-btn:hover {
transform: translateY(-2px);
box-shadow: 0 5px 10px rgba(243, 156, 18, 0.4);
}

/* CONTROLS */
.controls-row-audit {
display: flex;
gap: 6px;
margin-bottom: 8px;
flex-wrap: nowrap;
overflow-x: auto;
padding-bottom: 5px;
scrollbar-width: thin;
scrollbar-color: #3498db #f0f0f0;
}

.controls-row-audit::-webkit-scrollbar {
height: 6px;
}

.controls-row-audit::-webkit-scrollbar-track {
background: #f0f0f0;
border-radius: 3px;
}

.controls-row-audit::-webkit-scrollbar-thumb {
background: #3498db;
border-radius: 3px;
}

.controls-row-audit button {
padding: 8px 10px;
border: none;
border-radius: 3px;
cursor: pointer;
font-weight: bold;
font-size: 0.75em;
height: 32px;
white-space: nowrap;
overflow: hidden;
text-overflow: ellipsis;
min-width: 100px;
flex-shrink: 0;
}

.btn-back { background: #7f8c8d; color: white; }
.btn-export { background: #27ae60; color: white; }
.btn-report { background: #f39c12; color: white; }
.btn-desktop { background: #95a5a6; color: white; }
.btn-danger { background: #e74c3c; color: white; }
.btn-success { background: #27ae60; color: white; }
.btn-secondary {
background: #bdc3c7;
color: white;
border: none;
border-radius: 3px;
padding: 5px 8px;
font-weight: bold;
cursor: pointer;
height: 32px;
font-size: 0.75em;
}
button:hover { opacity: 0.9; }

/* STATUSLEISTE */
.audit-status {
margin-bottom: 6px;
font-size: 0.9em;
background: #f8f9fa;
padding: 6px;
border-radius: 4px;
border: 1px solid #ddd;
display: flex;
flex-direction: column;
gap: 8px;
}
.status-header {
display: flex;
justify-content: space-between;
align-items: center;
flex-wrap: wrap;
gap: 5px;
}
.status-text {
font-weight: 600;
color: #2c3e50;
display: flex;
align-items: center;
gap: 5px;
}
.status-text strong { color: #3498db; }
.progress-container { flex: 1; min-width: 200px; max-width: 400px; }
.progress-bar {
width: 100%; height: 8px; background: #e0e0e0; border-radius: 5px;
overflow: hidden; position: relative;
}
.progress-fill {
height: 100%; background: linear-gradient(90deg, #3498db, #2ecc71);
border-radius: 5px; transition: width 0.3s ease; position: relative;
}
.progress-text {
position: absolute; right: 10px; top: 50%; transform: translateY(-50%);
font-size: 0.8em; color: #666; font-weight: bold;
}

/* MITARBEITERLISTE TABELLE */
.employee-table {
width: 100%;
border-collapse: collapse;
margin-top: 10px;
font-size: 0.85em;
}
.employee-table th {
background: #34495e; color: white; padding: 10px; text-align: left; font-weight: bold;
position: sticky; top: 0;
}
.employee-table td {
padding: 8px 10px; border-bottom: 1px solid #eee; vertical-align: middle;
}
.employee-table tr:hover { background: #f8f9fa; }
.employee-table tr.expired { background: #fff0f0; }
.employee-table tr.valid { background: #f0fff4; }
.employee-table tr.warning { background: #fff3cd; }
.employee-table tr.missing { background: #e2e3e5; }
.status-badge {
display: inline-block; padding: 3px 8px; border-radius: 12px;
font-size: 0.8em; font-weight: bold; text-align: center; min-width: 80px;
}
.status-valid { background: #d4edda; color: #155724; }
.status-expired { background: #f8d7da; color: #721c24; }
.status-warning { background: #fff3cd; color: #856404; }
.status-missing { background: #e2e3e5; color: #383d41; }
.glasses-icon { font-size: 1.2em; }
.audit-procedures { display: flex; flex-wrap: wrap; gap: 5px; margin-top: 5px; }
.procedure-badge {
padding: 2px 6px; border-radius: 3px; font-size: 0.75em; background: #e9ecef; color: #495057;
}
.procedure-valid { background: #d4edda; color: #155724; }
.procedure-expired { background: #f8d7da; color: #721c24; }
.procedure-warning { background: #fff3cd; color: #856404; }

/* MITARBEITERLISTE SEITE */
.employee-view { display: none; }
.employee-view.active { display: block; }

.employee-controls {
display: flex; gap: 6px; align-items: center; flex-wrap: wrap;
margin-top: 10px; margin-bottom: 10px;
}
.employee-search {
flex: 1; min-width: 200px; padding: 6px;
border: 1px solid #ccc; border-radius: 4px; font-size: 0.9em;
}
.employee-filter {
padding: 6px; border: 1px solid #ccc; border-radius: 4px; font-size: 0.9em;
}

.stats-container {
display: flex; gap: 6px; flex-wrap: wrap; margin-top: 15px; margin-bottom: 10px;
}
.stat-box {
background: #f8f9fa; padding: 8px 12px; border-radius: 6px; border: 1px solid #ddd;
min-width: 100px; text-align: center;
}
.stat-value { 
font-weight: 700; 
font-size: 1.2em; 
margin-bottom: 3px; 
color: #000!important;
}

#employeeListView .controls-row-1 {
display: flex; flex-wrap: nowrap; gap: 6px; align-items: center;
}
#employeeListView .controls-row-1 button { flex: 0 0 auto; }

/* KOPFDATEN SECTION */
.header-section {
background: #f8f9fa; border: 1px solid #3498db; border-radius: 5px;
margin-bottom: 10px; transition: all 0.3s ease;
}
.header-section h3 {
color: #2c3e50; margin: 0; padding: 8px 10px; text-align: center; font-size: 0.85em;
display: flex; justify-content: space-between; align-items: center; cursor: pointer;
font-weight: 600;
}
.toggle-header-btn {
background: #3498db; color: white; border: none; border-radius: 3px; padding: 4px 8px;
font-size: 0.85em; cursor: pointer; appearance: none; min-width: 60px;
}
.header-content { max-height: 1000px; overflow: hidden; transition: max-height 0.3s ease-out, padding 0.3s ease-out; }
.header-content.collapsed { max-height: 0; padding: 0 !important; overflow: hidden; }
.header-grid {
display: grid; grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
gap: 8px; padding: 10px;
}
.header-group { background: white; padding: 8px; border-radius: 4px; border: 1px solid #ddd; }
.header-group h4 {
color: #2c3e50; margin-bottom: 5px; border-bottom: 1px solid #ecf0f1; padding-bottom: 3px; font-size: 0.9em;
}
.header-input {
width: 100%; padding: 6px 8px; border: 1px solid #ddd; border-radius: 3px;
font-family: inherit; font-size: 0.8em; margin-bottom: 6px; box-sizing: border-box; appearance: none;
}
.header-input:last-child { margin-bottom: 0; }

/* MOBILE HEADER - KOMPAKT */
.mobile-header-section.collapsed { padding: 2px; }
.mobile-header-section.collapsed h3 { padding: 4px 6px; font-size: 0.75em; min-height: 24px; }

/* FRAGEN UND SECTIONS */
.section { margin-bottom: 15px; border: 1px solid #bdc3c7; border-radius: 5px; overflow: hidden; }
.section-header {
background: #34495e; color: white; padding: 10px 12px; cursor: pointer;
display: flex; justify-content: space-between; align-items: center; user-select: none;
}
.section-header:hover { background: #2c3e50; }
.section-header h2 { margin: 0; font-size: 1em; font-weight: 600; }
.section-header span { transition: transform 0.3s; }
.section.expanded .section-header span { transform: rotate(90deg); }
.section-content { padding: 10px; display: none; }
.section.expanded .section-content { display: block; animation: fadeIn 0.3s ease-out; }
@keyframes fadeIn { from { opacity: 0; } to { opacity: 1; } }

.question {
margin-bottom: 10px; padding: 15px; background: #f8f9fa; border-radius: 4px; border-left: 3px solid #95a5a6;
}
.question.ok { border-left-color: #27ae60; background: #f0fff4; }
.question.not-ok { border-left-color: #e74c3c; background: #fff0f0; }
.question-header { display: flex; justify-content: space-between; align-items: flex-start; margin-bottom: 10px; }
.question-text { flex: 1; font-weight: 500; font-size: 1.1em; line-height: 1.4; }
.question-id {
background: #3498db; color: white; padding: 3px 8px; border-radius: 3px; font-size: 1.25em;
margin-left: 8px; white-space: nowrap; flex-shrink: 0;
}
.english-translation {
font-style: italic; color: #666; font-size: 0.9em; margin-top: 5px; margin-bottom: 10px; padding-left: 10px; border-left: 2px solid #ddd;
}

/* Ja/Nein Buttons */
.verdict-options { display: flex; gap: 10px; margin-bottom: 10px; }
.verdict-btn {
flex: 1; padding: 10px; border: none; border-radius: 4px; cursor: pointer; text-align: center;
font-weight: bold; font-size: 0.9em; transition: all 0.2s; display: flex; align-items: center; justify-content: center; gap: 5px;
}
.verdict-btn:hover { transform: translateY(-2px); box-shadow: 0 2px 5px rgba(0,0,0,0.2); }
.verdict-btn.ok { background: #e8f6f3; color: #27ae60; border: 2px solid #27ae60; }
.verdict-btn.ok.selected { background: #27ae60; color: white; }
.verdict-btn.not-ok { background: #ffebee; color: #e74c3c; border: 2px solid #e74c3c; }
.verdict-btn.not-ok.selected { background: #e74c3c; color: white; }

.comment-section { margin-bottom: 10px; }
.comment-label { display: block; margin-bottom: 5px; font-weight: 500; color: #2c3e50; font-size: 0.85em; }
.comment { width: 100%; padding: 10px; border: 1px solid #ddd; border-radius: 4px; resize: vertical; min-height: 60px; font-family: inherit; font-size: 0.85em; box-sizing: border-box; }

/* Bild-Upload */
.image-upload-section {
margin-top: 10px; padding: 10px; background: #f8f9fa; border-radius: 4px; border: 1px dashed #3498db;
}
.image-upload-section h4 { color: #2c3e50; margin-bottom: 6px; font-size: 0.85em; }
.file-input-wrapper { position: relative; display: inline-block; margin-bottom: 5px; }
.file-input { position: absolute; left: 0; top: 0; opacity: 0; width: 100%; height: 100%; cursor: pointer; }
.file-input-label {
display: inline-block; padding: 5px 12px; background: #3498db; color: white; border-radius: 4px; cursor: pointer; font-size: 0.8em; font-weight: 500;
}
.image-preview-container { display: flex; flex-wrap: wrap; gap: 10px; margin-top: 10px; }
.image-preview-item {
position: relative; width: 100px; height: 100px; border: 1px solid #ddd; border-radius: 4px; overflow: hidden; flex-shrink: 0;
}
.image-preview { width: 100%; height: 100%; object-fit: cover; }
.remove-image {
position: absolute; top: 2px; right: 2px; background: #e74c3c; color: white; border: none;
width: 20px; height: 20px; border-radius: 50%; cursor: pointer; font-size: 0.8em; display: flex; align-items: center; justify-content: center; line-height: 1;
}

/* GESAMTERGEBNIS */
.final-result { text-align: center; margin: 10px 0; padding: 12px; border-radius: 5px; font-weight: bold; font-size: 0.9em; display: none; }
.final-result.passed { background: #d4edda; color: #155724; border: 1px solid #c3e6cb; }
.final-result.failed { background: #f8d7da; color: #721c24; border: 1px solid #f5c6cb; }
.final-result.warning { background: #fff3cd; color: #856404; border: 1px solid #ffeaa7; }

/* MOBILE ANSICHT */
.mobile-view { display: none; }
.desktop-view { display: block; }

/* MOBILE NAVIGATION */
.mobile-nav {
display: flex; justify-content: space-between; margin-top: 5px; border-top: 1px solid #ddd;
}
.mobile-nav button {
padding: 10px 15px; font-size: 0.8em; min-width: 80px; border: none; border-radius: 4px; background: #95a5a6; color: white; cursor: pointer;
}
#mobileCounter {
font-size: 0.9em; padding: 0 15px; text-align: center; font-weight: bold; color: #2c3e50; display: flex; align-items: center;
}

/* KATEGORIEN-BUTTONS F√úR MOBILE */
.mobile-section-selector {
display: flex; flex-wrap: wrap; gap: 5px; margin-bottom: 10px; background: #f8f9fa; padding: 8px; border-radius: 4px;
}
.section-btn {
flex: 1; min-width: 60px; font-size: 0.7em; padding: 6px 4px; text-align: center; white-space: nowrap; overflow: hidden; text-overflow: ellipsis;
border: none; border-radius: 3px; background: #3498db; color: white; cursor: pointer;
}
.section-btn.active { background: #2c3e50; font-weight: bold; }

/* BERICHTSANZEIGE OVERLAY */
.report-overlay {
display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%;
background: rgba(0,0,0,0.95); z-index: 1000; overflow-y: auto; padding: 10px; box-sizing: border-box;
}
.report-container {
background: white !important; color: #000 !important;
width: 95%; max-width: 800px; margin: 0 auto 20px auto; border-radius: 0;
font-family: 'Arial', sans-serif; position: relative; padding: 20px;
box-shadow: 0 5px 30px rgba(0,0,0,0.5);
height: auto; min-height: auto;
}
.report-action-buttons {
position: absolute; top: 10px; right: 10px; display: flex; gap: 5px; z-index: 1002;
}
.report-action-btn {
background: #3498db; color: white; border: none; width: 30px; height: 30px; border-radius: 50%;
cursor: pointer; font-size: 16px; display: flex; align-items: center; justify-content: center;
opacity: 0.7; transition: opacity 0.3s;
}
.report-action-btn:hover { opacity: 1; }
.report-action-btn.print-btn { background: #27ae60; }
.report-action-btn.close-btn { background: #e74c3c; }
.report-action-btn.cloud-btn { background: #9b59b6; }

.report-header {
position: relative; border-bottom: 2px solid #000; padding-bottom: 5px; margin-bottom: 15px;
text-align: center; height: auto; min-height: 10mm; max-height: 15mm;
}
.report-header h2 { font-size: 16px !important; margin: 0 0 2px 0; color: #000 !important; line-height: 1.2; }
.company-info { font-size: 11px; margin: 1px 0; color: #333 !important; }

/* Tabellen */
.person-table {
width: 100%; border-collapse: collapse; margin: 10px 0; font-size: 10px;
}
.person-table th, .person-table td {
border: 1px solid #000; padding: 6px; vertical-align: top;
}
.person-table th { background: #f0f0f0 !important; font-weight: bold; text-align: left; }

.details-table { width: 100%; border-collapse: collapse; margin: 10px 0; font-size: 10px; }
.details-table td { border: 1px solid #000; padding: 5px 6px; vertical-align: middle; }
.details-table td:first-child {width: 25%; background: #f9f9f9 !important; }

/* Ergebnisse */
.results-section { margin: 15px 0; }
.report-section-header {
font-size: 12px; font-weight: bold; margin: 10px 0 5px 0; padding-bottom: 3px; border-bottom: 1px solid #000;
}
.question-item { margin: 4px 0; padding: 5px; font-size: 10px; line-height: 1.3; }
.question-item.ok { border-left: 2px solid #00a000; background: #f0fff0 !important; }
.question-item.not-ok { border-left: 2px solid #ff0000; background: #fff0f0 !important; }
.question-id { font-weight: bold; color: #000 !important; font-size: 10px; }
.question-comment { font-style: italic; color: #666; margin-left: 8px; font-size: 9px; }

/* Unterschriften */
.signature-area {
margin-top: 30px; padding-top: 15px; border-top: 1px solid #000;
display: flex; justify-content: space-between; gap: 20px;
}
.signature-box { flex: 1; text-align: center; min-width: 45%; }
.signature-line { margin-top: 50px; min-height: 40px; }

/* AUTORISIERUNGS-BERICHT - OPTIMIERTE VERSION */
.authorization-header {
position: relative; 
text-align: center; 
border-bottom: 0.5px solid #000 !important; 
padding-bottom: 15px; 
margin-bottom: 20px;
}
.authorization-header h1 { 
font-size: 24px; 
margin: 0 0 10px 0; 
color: #000 !important; 
}

.authorization-header .english-subtitle {
font-style: italic !important;
font-weight: normal !important;
color: #000 !important;
margin-top: 5px;
font-size: 9pt;
}

.header-section-title .english {
font-style: italic !important;
font-weight: normal !important;
color: #666 !important;
display: block;
margin-top: 2px;
font-size: 0.85em;
}

.authorization-info {
margin: 15px 0; 
padding: 10px; 
border: 0.5px solid #000 !important;
background: #f9f9f9;
}

.authorization-text-box {
border: 0.5px solid #000 !important;
padding: 20px; 
margin: 20px 0; 
font-size: 14px; 
line-height: 1.5; 
background: #f9f9f9 !important; 
min-height: 100px;
}

.authorization-details {
margin: 20px 0; 
padding: 15px; 
border: 0.5px solid #000 !important;
background: #fff;
}

.authorization-details p { margin: 8px 0; font-size: 13px; }
.authorization-signatures {
margin-top: 40px; 
padding-top: 20px; 
border-top: 0.5px solid #000 !important;
display: flex; 
justify-content: space-between; 
gap: 30px;
}
.authorization-signature-field { 
flex: 1; 
text-align: center; 
min-width: 45%; 
}
.authorization-signature-line { 
margin-top: 50px; 
padding-top: 8px; 
min-height: 40px; 
}

.authorization-stamp-box {
text-align: center; 
margin: 30px auto 15px auto !important;
padding: 15px; 
border: 0.5px solid #000 !important;
border-radius: 10px; 
background: #fff; 
display: inline-block;
width: 80% !important;
max-width: 140mm !important;
position: relative !important;
z-index: 1 !important;
}

.authorization-stamp-box.supervisor {
margin: 25px auto 10px auto !important;
width: 85% !important;
max-width: 150mm !important;
}

.print-container {
position: relative;
min-height: 297mm !important;
padding-bottom: 12mm !important;
}

.authorization-footer {
position: absolute !important;
bottom: 3mm !important;
left: 5mm !important;
right: 5mm !important;
padding-top: 8px !important;
border-top: 0.5px solid #ccc !important;
font-size: 8pt !important;
color: #444 !important;
height: auto !important;
max-height: 8mm !important;
background: white !important;
z-index: 10 !important;
}

/* ANSICHTS-STEUERUNG */
.audit-content { display: none; }
.audit-content.active { display: block; }
.audit-selection { display: none; }
.audit-selection.active { display: block; }

/* FOOTER */
footer {
text-align: center; margin-top: 12px; padding-top: 8px; border-top: 1px solid #ecf0f1;
color: #7f8c8d; font-size: 0.85em;
}
.creator-info { font-weight: bold; color: #2c3e50; margin-top: 4px; font-size: 0.9em; }
.version-info { margin-top: 2px; font-size: 0.8em; color: #7f8c8d; }

/* DARK MODE */
@media (prefers-color-scheme: dark) {
body { 
background-color: #121212; 
color: #e0e0e0 !important;
}
.container { 
background: #1e1e1e; 
box-shadow: 0 2px 8px rgba(0,0,0,0.3);
color: #e0e0e0 !important;
}
header { border-bottom-color: #444; }
h1 { 
color: #ffffff !important;
}
.subtitle { 
color: #cccccc !important;
}

.custom-modal-content, 
.employee-modal-content, 
.audit-list-content { 
background: #2d2d2d; 
color: #ffffff !important;
}

.custom-modal-content .custom-modal-btn,
.employee-modal-content .employee-form-group label,
.audit-list-content h3,
.employee-modal h3 {
color: #ffffff !important;
}

.employee-form-group label {
color: #ffffff !important;
}

.employee-form-group input,
.employee-form-group select,
.employee-form-group textarea {
background: #333;
border-color: #555;
color: #ffffff !important;
}

.employee-form-group input::placeholder,
.employee-form-group textarea::placeholder {
color: #888;
}

.audit-selection h2 {
color: #ffffff !important;
}

.audit-btn.wirbelstrom { background: #2980b9; color: white; }
.audit-btn.magnetpulver { background: #c0392b; color: white; }
.audit-btn.nital { background: #27ae60; color: white; }
.audit-btn.ultraschall { background: #8e44ad; color: white; }
.audit-btn.disabled { opacity: 0.4; background: #555; }
.audit-btn .btn-progress { background: rgba(255,255,255,0.1); }

.employee-list-btn { 
background: linear-gradient(135deg, #d35400, #e67e22) !important; 
color: white !important;
}

.btn-back, .btn-export, .btn-export, .btn-authorization,
.btn-report, .btn-desktop, .btn-danger, .btn-success,
.btn-secondary {
color: white !important;
}
.btn-back { background: #666; }
.btn-export { background: #219653; }
.btn-export { background: #2980b9; }
.btn-authorization { background: #8e44ad; }
.btn-report { background: #d35400; }
.btn-desktop { background: #7f8c8d; }
.btn-danger { background: #c0392b; }
.btn-success { background: #27ae60; }
.btn-secondary { background: #666; }

.audit-status { 
background: #2d2d2d; 
border-color: #444;
color: #ffffff !important;
}
.status-text { 
color: #ffffff !important;
}
.status-text strong { 
color: #3498db !important;
}
.progress-bar { background: #333; }
.progress-text { color: #b0b0b0; }

.employee-table th { 
background: #2c3e50; 
color: white !important;
}
.employee-table td { 
border-bottom-color: #444;
color: #ffffff !important;
}
.employee-table tr:hover { background: #2d2d2d; }
.employee-table tr.expired { background: rgba(231, 76, 60, 0.2); }
.employee-table tr.valid { background: rgba(39, 174, 96, 0.2); }
.employee-table tr.warning { background: rgba(243, 156, 18, 0.2); }
.employee-table tr.missing { background: rgba(149, 165, 166, 0.2); }

.employee-search, .employee-filter { 
background: #333; 
border-color: #555; 
color: #ffffff !important;
}
.employee-search::placeholder {
color: #888;
}

.stat-box { 
background: #2d2d2d; 
border-color: #444; 
}
.stat-value { 
color: #000000 !important;
font-weight: bold;
}
.stat-box div:not(.stat-value) {
color: #000000 !important;
}

.header-section { 
background: #2d2d2d; 
border-color: #2980b9;
}
.header-section h3 { 
color: #ffffff !important; 
font-weight: 600;
}
.header-group { 
background: #252525; 
border-color: #444;
}
.header-group h4 { 
color: #ffffff !important; 
border-bottom-color: #444;
}
.header-input { 
background: #333; 
border-color: #555; 
color: #ffffff !important;
}
.header-input::placeholder { 
color: #888;
}

.section { border-color: #444; }
.section-header { 
background: #2c3e50;
color: #ffffff !important;
}
.section-header:hover { background: #34495e; }
.question { 
background: #252525; 
border-left-color: #666;
color: #ffffff !important;
}
.question.ok { 
border-left-color: #27ae60; 
background: rgba(39, 174, 96, 0.15);
color: #ffffff !important;
}
.question.not-ok { 
border-left-color: #e74c3c; 
background: rgba(231, 76, 60, 0.15);
color: #ffffff !important;
}
.question-id { 
background: #3498db; 
color: white !important;
}
.english-translation { 
color: #b0b0b0 !important; 
border-left-color: #666;
}

.verdict-btn.ok { 
background: rgba(39, 174, 96, 0.15); 
color: #2ecc71 !important; 
border-color: #27ae60;
}
.verdict-btn.ok.selected { 
background: #27ae60; 
color: white !important;
}
.verdict-btn.not-ok { 
background: rgba(231, 76, 60, 0.15); 
color: #e74c3c !important; 
border-color: #e74c3c;
}
.verdict-btn.not-ok.selected { 
background: #e74c3c; 
color: white !important;
}

.comment-label { 
color: #ffffff !important;
}
.comment { 
background: #333; 
border-color: #555; 
color: #ffffff !important;
}
.comment::placeholder { 
color: #888;
}

.image-upload-section { 
background: rgba(52, 152, 219, 0.05); 
border-color: #3498db;
}
.image-upload-section h4 { 
color: #ffffff !important;
}
.file-input-label { 
background: #2980b9; 
color: white !important;
}
.image-preview-item { 
border-color: #666; 
background: #333;
}
.remove-image { 
background: #c0392b; 
color: white !important;
}

.final-result.passed { 
background: rgba(39, 174, 96, 0.2); 
color: #2ecc71 !important; 
border-color: #27ae60;
}
.final-result.failed { 
background: rgba(231, 76, 60, 0.2); 
color: #ff6b6b !important; 
border-color: #e74c3c;
}
.final-result.warning { 
background: rgba(243, 156, 18, 0.2); 
color: #f1c40f !important; 
border-color: #f39c12;
}

.mobile-nav { border-top-color: #444; }
.mobile-nav button { 
background: #666; 
color: white !important;
}
#mobileCounter { 
color: #ffffff !important;
}

.mobile-section-selector { background: #2d2d2d; }
.section-btn { 
background: #2980b9; 
color: white !important;
}
.section-btn.active { 
background: #3498db; 
font-weight: bold;
}

.report-overlay { background: rgba(0,0,0,0.95); }
.report-container, #authorizationContainer { 
background: white !important; 
color: #000 !important;
}
.report-action-btn { 
background: #2980b9 !important; 
color: white !important;
}
.report-action-btn.print-btn { background: #219653 !important; }
.report-action-btn.close-btn { background: #c0392b !important; }
.report-action-btn.cloud-btn { background: #8e44ad !important; }

footer { 
border-top-color: #444; 
color: #cccccc !important;
}
.creator-info { 
color: #ffffff !important;
}
.version-info { 
color: #aaaaaa;
}

.audit-item {
background: #2d2d2d;
border-color: #444;
color: #ffffff !important;
}
.audit-item.has-deviations {
background: rgba(231, 76, 60, 0.15);
border-color: #e74c3c;
}
.audit-item-title {
color: #ffffff !important;
}
.audit-item-date {
color: #b0b0b0 !important;
}
.audit-item-details {
color: #d0d0d0 !important;
}
.audit-item-deviations {
color: #ff6b6b !important;
}
.mark-reviewed-btn {
color: white !important;
}

.status-valid { 
background: #155724 !important; 
color: #ffffff !important; 
}
.status-expired { 
background: #721c24 !important; 
color: #ffffff !important; 
}
.status-warning { 
background: #856404 !important; 
color: #ffffff !important; 
}
.status-missing { 
background: #383d41 !important; 
color: #ffffff !important; 
}

.procedure-valid { 
background: #d4edda !important;
color: #000000 !important;
}
.procedure-expired { 
background: #f8d7da !important;
color: #000000 !important;
}
.procedure-warning { 
background: #fff3cd !important;
color: #000000 !important;
}

.authorization-header .english-subtitle {
color: #ffffff !important;
}

.header-section-title .english {
color: #cccccc !important;
}
}

/* MOBILE OPTIMIERUNGEN */
@media (max-width: 768px) {
body { padding: 4px; font-size: 13px; }
.container { padding: 6px; }
.desktop-view { display: none !important; }
.mobile-view { display: block !important; }
header h1 { font-size: 0.9em !important; margin-bottom: 2px; }
.subtitle { font-size: 0.8em; margin-bottom: 6px; }

.audit-status { padding: 8px; font-size: 0.8em; gap: 6px; }
.status-header { flex-direction: column; align-items: stretch; gap: 6px; }
.progress-container { min-width: 100%; max-width: 100%; }

.controls-row-audit {
display: flex;
gap: 3px;
margin-bottom: 8px;
flex-wrap: nowrap;
overflow-x: auto;
padding-bottom: 5px;
scrollbar-width: thin;
scrollbar-color: #3498db #f0f0f0;
}

.controls-row-audit button {
padding: 8px 10px;
font-size: 0.7em;
height: 32px;
min-width: 100px;
flex-shrink: 0;
}

.audit-buttons { grid-template-columns: 1fr; gap: 5px; }
.audit-btn {
padding: 10px 8px; min-height: 70px; font-size: 0.85em;
flex-direction: row; justify-content: flex-start; text-align: left; padding-left: 15px;
}
.audit-btn .btn-icon { font-size: 1.4em; margin-right: 10px; margin-bottom: 0; }
.audit-btn .btn-progress { margin-left: auto; margin-top: 0; font-size: 0.7em; }

.employee-table { 
font-size: 0.7em; 
width: 100%;
display: block;
overflow-x: auto;
-webkit-overflow-scrolling: touch;
}
.employee-table thead {
display: table;
width: 100%;
table-layout: fixed;
}
.employee-table tbody {
display: table;
width: 100%;
table-layout: fixed;
}
.employee-table tr {
display: table;
width: 100%;
table-layout: fixed;
}
.employee-table th, .employee-table td { 
padding: 6px 4px; 
box-sizing: border-box;
min-width: 80px;
max-width: 150px;
overflow: hidden;
text-overflow: ellipsis;
white-space: nowrap;
}
.employee-table th:nth-child(1), .employee-table td:nth-child(1) { width: 80px; }
.employee-table th:nth-child(2), .employee-table td:nth-child(2) { width: 120px; }
.employee-table th:nth-child(3), .employee-table td:nth-child(3) { width: 90px; }
.employee-table th:nth-child(4), .employee-table td:nth-child(4) { width: 70px; }
.employee-table th:nth-child(5), .employee-table td:nth-child(5) { width: 90px; }
.employee-table th:nth-child(6), .employee-table td:nth-child(6) { width: 90px; }
.employee-table th:nth-child(7), .employee-table td:nth-child(7) { width: 100px; }
.employee-table th:nth-child(8), .employee-table td:nth-child(8) { width: 100px; }
.employee-table th:nth-child(9), .employee-table td:nth-child(9) { 
min-width: 140px; 
max-width: 180px; 
white-space: normal !important;
}
.employee-table th:nth-child(10), .employee-table td:nth-child(10) { width: 150px; }

.employee-controls { flex-direction: column; align-items: stretch; }
.employee-search, .employee-filter { width: 100%; margin-bottom: 5px; }
.stats-container { flex-direction: column; }
.stat-box { width: 100%; text-align: left; display: flex; justify-content: space-between; }

.mobile-header-section.collapsed { padding: 0; margin-bottom: 5px; min-height: 28px; }
.mobile-header-section.collapsed h3 { padding: 3px 6px; font-size: 0.7em; min-height: 24px; margin: 0; }
.mobile-header-section h3 { padding: 5px 8px; font-size: 0.75em; min-height: 26px; }
.toggle-header-btn { padding: 2px 6px; font-size: 0.55em; min-width: 50px; }

.header-grid { grid-template-columns: 1fr; }
.header-content.collapsed { max-height: 0; overflow: hidden; }
.header-input { padding: 8px 10px; font-size: 0.9em; margin-bottom: 8px; }
.header-group { padding: 10px; }
.header-group h4 { font-size: 0.85em; margin-bottom: 6px; }

.question { padding: 12px; }
.question-text { font-size: 0.95em; font-weight: 600; line-height: 1.45; }
.question-id { font-size: 0.8em; margin-left: 8px; }
.english-translation { font-size: 0.85em; color: #555; margin-top: 8px; margin-bottom: 15px; padding-left: 10px; border-left: 2px solid #ddd; }

.verdict-options { flex-direction: row !important; gap: 8px; margin-bottom: 12px; }
.verdict-btn { flex: 1; padding: 8px 6px; font-size: 0.85em; min-height: 40px; display: flex; align-items: center; justify-content: center; }

.comment-section { margin-bottom: 10px; }
.comment { min-height: 50px !important; padding: 8px; font-size: 0.85em; line-height: 1.3; }
.comment-label { margin-bottom: 4px; font-size: 0.8em; }

.image-upload-section { padding: 10px; margin-top: 12px; }
.image-upload-section h4 { font-size: 0.8em; margin-bottom: 6px; }
.file-input-label { padding: 6px 10px; font-size: 0.75em; }
.image-preview-container { gap: 6px; margin-top: 8px; }
.image-preview-item { width: 70px; height: 70px; }
.remove-image { width: 18px; height: 18px; font-size: 0.7em; }

.mobile-nav button { min-width: 70px; padding: 8px 10px; font-size: 0.8em; }

.report-container { margin: 0; padding: 10px; width: 100%; box-shadow: none; }
.report-header h2 { font-size: 14px !important; }
.person-table, .details-table { font-size: 9px; }

.signature-area { flex-direction: column !important; gap: 15px !important; }
.signature-box { width: 100% !important; margin-bottom: 15px !important; }

.authorization-header h1 { font-size: 20px !important; }
.authorization-signatures { flex-direction: column !important; gap: 20px !important; }
.authorization-signature-field { width: 100% !important; margin-bottom: 20px !important; }

.report-action-buttons { top: 5px; right: 5px; gap: 3px; }
.report-action-btn { width: 25px; height: 25px; font-size: 14px; }
}

/* SEHR KLEINE DISPLAYS */
@media (max-width: 360px) {
.audit-status { font-size: 0.7em; padding: 6px; }
.controls-row-audit button { padding: 6px 8px; font-size: 0.65em; height: 30px; min-width: 90px; }
.audit-btn { padding: 8px 6px; min-height: 60px; font-size: 0.8em; }
.question-text { font-size: 0.9em; }
.verdict-btn { padding: 6px 4px; font-size: 0.8em; min-height: 36px; }
.verdict-btn span { font-size: 0.9em; margin-right: 3px; }
.comment { min-height: 45px !important; padding: 6px; font-size: 0.8em; }
.image-preview-item { width: 60px; height: 60px; }
.mobile-nav button { min-width: 60px; padding: 6px 8px; font-size: 0.75em; }
.progress-bar { height: 8px; }
}
/* === ANPASSUNGEN F√úR MITARBEITERLISTE CONTROLS === */

#employeeListView .controls-row-1 {
    display: flex;
    gap: 6px;
    margin-bottom: 8px;
    flex-wrap: nowrap;
    overflow-x: auto;
    padding-bottom: 5px;
    scrollbar-width: thin;
    scrollbar-color: #3498db #f0f0f0;
}

#employeeListView .controls-row-1::-webkit-scrollbar {
    height: 6px;
}

#employeeListView .controls-row-1::-webkit-scrollbar-track {
    background: #f0f0f0;
    border-radius: 3px;
}

#employeeListView .controls-row-1::-webkit-scrollbar-thumb {
    background: #3498db;
    border-radius: 3px;
}

#employeeListView .controls-row-1 button {
    padding: 8px 10px;
    border: none;
    border-radius: 3px;
    cursor: pointer;
    font-weight: bold;
    font-size: 0.75em;
    height: 32px;
    white-space: nowrap;
    overflow: hidden;
    text-overflow: ellipsis;
    min-width: 100px;
    flex-shrink: 0;
    color: white !important;
}

#employeeListView .controls-row-1 .btn-back { background: #7f8c8d; }
#employeeListView .controls-row-1 .btn-success { background: #27ae60; }
#employeeListView .controls-row-1 .btn-export { background: #3498db; }
#employeeListView .controls-row-1 .btn-authorization { background: #9b59b6; }

#employeeListView .controls-row-1 button:hover {
    opacity: 0.9;
    transform: translateY(-1px);
}

/* Mobile Ansicht f√ºr die Steuerungsbuttons */
@media (max-width: 768px) {
    #employeeListView .controls-row-1 {
        gap: 3px;
        margin-bottom: 6px;
        padding-bottom: 6px;
    }
    
    #employeeListView .controls-row-1 button {
        padding: 6px 8px;
        font-size: 0.7em;
        height: 30px;
        min-width: 90px;
    }
}

/* Sehr kleine Displays */
@media (max-width: 360px) {
    #employeeListView .controls-row-1 button {
        padding: 5px 6px;
        font-size: 0.65em;
        height: 28px;
        min-width: 80px;
    }
}
/* FIX F√úR VERFAHREN-SPALTE AUF MOBILE */
@media (max-width: 768px) {
.employee-table td:nth-child(9),
.employee-table th:nth-child(9) {
display: table-cell !important;
visibility: visible !important;
width: 180px !important;
min-width: 180px !important;
}
}
</style>
</head>
<body>
<!-- CUSTOM MODAL -->
<div id="customModal" class="custom-modal">
<div class="custom-modal-content">
<div id="modalMessage">M√∂chten Sie fortfahren?</div>
<div class="custom-modal-buttons">
<button id="modalCancelBtn" class="custom-modal-btn cancel">Nein</button>
<button id="modalConfirmBtn" class="custom-modal-btn confirm">Ja</button>
</div>
</div>
</div>

<!-- MITARBEITER MODAL -->
<div id="employeeModal" class="employee-modal">
<div class="employee-modal-content">
<h3 id="employeeModalTitle">Mitarbeiter hinzuf√ºgen</h3>
<div class="employee-form">
<div class="employee-form-group">
<label for="employeeName">Name:</label>
<input type="text" id="employeeName" placeholder="Vorname Nachname">
</div>
<div class="employee-form-group">
<label for="employeeNumber">Personalnummer:</label>
<input type="text" id="employeeNumber" placeholder="z.B. 123456">
</div>
<div class="employee-form-group">
<label for="employeeBirthdate">Geburtsdatum:</label>
<input type="text" id="employeeBirthdate" placeholder="TT.MM.JJJJ (optional)">
</div>
<div class="employee-form-group">
<label for="employeeEyeTest">Letzter Sehtest:</label>
<input type="text" id="employeeEyeTest" placeholder="TT.MM.JJJJ (optional)">
</div>
<div class="employee-form-group">
<label for="employeeCertNumber">Identifikationsnummer:</label>
<input type="text" id="employeeCertNumber" placeholder="(optional)">
</div>
<div class="employee-form-group">
<label for="employeeGlasses">Brille ben√∂tigt:</label>
<select id="employeeGlasses">
<option value="yes">Ja</option>
<option value="no">Nein</option>
<option value="unknown">Unbekannt</option>
</select>
</div>
<div class="employee-form-group">
<label for="employeeDepartment">Abteilung:</label>
<input type="text" id="employeeDepartment" placeholder="Optional">
</div>
<div class="employee-form-group">
<label for="employeeCertificate">Zertifikat(e):</label>
<input type="text" id="employeeCertificate" placeholder="Optional, durch Komma getrennt">
</div>
<div class="employee-form-group">
<label for="employeeNotes">Notizen:</label>
<input type="text" id="employeeNotes" placeholder="Optionale Notizen">
</div>
</div>

<div class="employee-modal-buttons">
<button id="employeeModalCancel" class="custom-modal-btn cancel">Abbrechen</button>
<button id="employeeModalSave" class="custom-modal-btn confirm">Speichern</button>
</div>
</div>
</div>

<!-- AUDIT LISTE MODAL -->
<div id="auditListModal" class="audit-list-modal">
<div class="audit-list-content">
<h3 id="auditListTitle">Audits f√ºr Mitarbeiter</h3>
<div id="auditListContainer"></div>
<div class="employee-modal-buttons">
<button id="auditListClose" class="custom-modal-btn cancel">Schlie√üen</button>
<button id="auditListLoadAll" class="custom-modal-btn confirm">Alle in Cloud speichern</button>
</div>
</div>
</div>

<!-- CLOUD SYNC MODAL -->
<div id="cloudSyncModal" class="custom-modal">
<div class="custom-modal-content">
<h3 id="cloudSyncTitle">Cloud-Synchronisation</h3>
<div id="cloudSyncMessage">Verbindung wird hergestellt...</div>
<div id="cloudSyncProgress" style="margin: 15px 0;">
<div style="width: 100%; height: 10px; background: #e0e0e0; border-radius: 5px;">
<div id="cloudSyncProgressBar" style="width: 0%; height: 100%; background: #3498db; border-radius: 5px; transition: width 0.3s;"></div>
</div>
<div id="cloudSyncProgressText" style="text-align: center; margin-top: 5px; font-size: 0.9em;">0%</div>
</div>
<div class="custom-modal-buttons">
<button id="cloudSyncCancel" class="custom-modal-btn cancel">Abbrechen</button>
<button id="cloudSyncConfirm" class="custom-modal-btn confirm" style="display: none;">Fortfahren</button>
</div>
</div>
</div>

<div class="container">
<header>
<h1>ZfP Operator Audit</h1>
<div class="subtitle">Zerst√∂rungsfreie Pr√ºfverfahren - Operator Qualifizierung</div>
<div style="margin-top: 5px; font-size: 0.8em; color: #3498db; display: flex; align-items: center; justify-content: center; gap: 5px;">
<span id="cloudStatus">üåê Cloud verbunden</span>
</div>
</header>

<!-- AUDIT AUSWAHL -->
<div id="auditSelection" class="audit-selection active">
<h2>Pr√ºfverfahren ausw√§hlen:</h2>
<div class="audit-buttons">
<button class="audit-btn wirbelstrom" data-audit="wirbelstrom">
<div class="btn-icon">‚ö°</div>
<span>Wirbelstrompr√ºfung</span>
<div class="btn-progress" id="wirbelstromProgress">0%</div>
</button>
<button class="audit-btn magnetpulver" data-audit="magnetpulver">
<div class="btn-icon">üß≤</div>
<span>Magnetpulverpr√ºfung</span>
<div class="btn-progress" id="magnetpulverProgress">0%</div>
</button>
<button class="audit-btn nital" data-audit="nital">
<div class="btn-icon">üß™</div>
<span>Nital-√Ñtzen</span>
<div class="btn-progress" id="nitalProgress">0%</div>
</button>
<button class="audit-btn ultraschall" data-audit="ultraschall">
<div class="btn-icon">üì°</div>
<span>Ultraschallpr√ºfung</span>
<div class="btn-progress" id="ultraschallProgress">0%</div>
</button>
</div>

<!-- MITARBEITERLISTE BUTTON -->
<div style="margin-top: 25px; text-align: center;">
<button class="audit-btn employee-list-btn" id="employeeListBtn">
<div class="btn-icon" style="font-size: 1.8em;">üë•</div>
<span>Mitarbeiterliste & Audit-Status</span>
<div class="btn-progress" id="employeeStatus">0/0</div>
</button>
<div style="font-size: 0.8em; color: #7f8c8d; margin-top: 5px;">
Zeigt alle gepr√ºften Mitarbeiter und deren Audit-Status
</div>
</div>
</div>

<!-- AUDIT CONTENT -->
<div id="auditContent" class="audit-content">
<!-- CONTROLS -->
<div class="controls-row-audit">
<button class="btn-back" id="backBtn">‚Üê Zur√ºck</button>
<button class="btn-export" id="exportBtn">üíæ In Cloud speichern</button>
<button class="btn-report" id="reportBtn">üìä Auditbericht</button>
<button class="btn-desktop" id="toggleViewBtn">üì± Mobile</button>
<button class="btn-danger" id="resetBtn">üóëÔ∏è Reset Audit</button>
<button class="btn-success" id="uploadQuestionsBtn">üìÑ Fragenkatalog</button>
</div>

<!-- CLOUD SYNC INDICATOR -->
<div id="cloudSyncIndicator" style="display: none; background: #3498db; color: white; padding: 5px 10px; border-radius: 3px; margin-bottom: 8px; font-size: 0.8em; text-align: center;">
<span id="syncIndicatorText">üîÑ Synchronisiere mit Cloud...</span>
</div>

<!-- KOPFDATEN DESKTOP -->
<div class="header-section desktop-view" id="desktopHeaderSection">
<h3>
<span>üìÑ Audit-Kopfdaten</span>
<button class="toggle-header-btn" id="desktopToggleHeader">Ausblenden</button>
</h3>
<div class="header-content" id="desktopHeaderContent">
<div class="header-grid">
<div class="header-group">
<h4>Operator</h4>
<input type="text" class="header-input" id="operatorName" placeholder="Name">
<input type="text" class="header-input" id="operatorNumber" placeholder="Mitarbeiter-Nr.">
<input type="text" class="header-input" id="operatorCert" placeholder="Zertifikat">
<input type="text" class="header-input" id="operatorDept" placeholder="Abteilung">
</div>
<div class="header-group">
<h4>Auditor (Level II)</h4>
<input type="text" class="header-input" id="auditorName" placeholder="Name">
<input type="text" class="header-input" id="auditorDept" placeholder="Abteilung">
<input type="text" class="header-input" id="auditorCert" placeholder="Zertifikat">
<input type="text" class="header-input" id="auditorPhone" placeholder="Telefon">
</div>
<div class="header-group">
<h4>Supervisor (Level III)</h4>
<input type="text" class="header-input" id="approverName" placeholder="Name">
<input type="text" class="header-input" id="approverDept" placeholder="Abteilung">
<input type="text" class="header-input" id="approverCert" placeholder="Zertifikat">
<input type="text" class="header-input" id="approverPhone" placeholder="Telefon">
</div>
<div class="header-group">
<h4>Pr√ºfungsdetails</h4>
<input type="text" class="header-input" id="reportNumber" placeholder="Pr√ºfbericht-Nr.">
<input type="text" class="header-input" id="partType" placeholder="Teiletype">
<input type="text" class="header-input" id="externalStandard" placeholder="Externe Norm">
<input type="text" class="header-input" id="sStandard" placeholder="S-Standard">
<input type="text" class="header-input" id="workInstruction" placeholder="Lokale Instruktion">
</div>
</div>
</div>
</div>

<!-- Mobile Kopfdaten -->
<div class="header-section mobile-view mobile-header-section collapsed" id="mobileHeaderSection">
<h3>
<span>üìÑ Audit-Daten</span>
<button class="toggle-header-btn" id="mobileToggleHeader">Einblenden</button>
</h3>
<div class="header-content" id="mobileHeaderContent">
<div class="header-grid">
<div class="header-group">
<h4>Operator</h4>
<input type="text" class="header-input" id="mobileOperatorName" placeholder="Name">
<input type="text" class="header-input" id="mobileOperatorNumber" placeholder="Mitarbeiter-Nr.">
<input type="text" class="header-input" id="mobileOperatorCert" placeholder="Zertifikat">
<input type="text" class="header-input" id="mobileOperatorDept" placeholder="Abteilung">
</div>
<div class="header-group">
<h4>Auditor (Level II)</h4>
<input type="text" class="header-input" id="mobileAuditorName" placeholder="Name">
<input type="text" class="header-input" id="mobileAuditorDept" placeholder="Abteilung">
<input type="text" class="header-input" id="mobileAuditorCert" placeholder="Zertifikat">
<input type="text" class="header-input" id="mobileAuditorPhone" placeholder="Telefon">
</div>
<div class="header-group">
<h4>Freigeber (Level III)</h4>
<input type="text" class="header-input" id="mobileApproverName" placeholder="Name">
<input type="text" class="header-input" id="mobileApproverDept" placeholder="Abteilung">
<input type="text" class="header-input" id="mobileApproverCert" placeholder="Zertifikat">
<input type="text" class="header-input" id="mobileApproverPhone" placeholder="Telefon">
</div>
<div class="header-group">
<h4>Pr√ºfungsdetails</h4>
<input type="text" class="header-input" id="mobileReportNumber" placeholder="Pr√ºfbericht-Nr.">
<input type="text" class="header-input" id="mobilePartType" placeholder="Teiletype">
<input type="text" class="header-input" id="mobileExternalStandard" placeholder="Externe Norm">
<input type="text" class="header-input" id="mobileSStandard" placeholder="S-Standard">
<input type="text" class="header-input" id="mobileWorkInstruction" placeholder="Lokale Instruktion">
</div>
</div>
</div>
</div>

<!-- STATUSLEISTE -->
<div class="audit-status">
<div class="status-header">
<div class="status-text">
Status: <strong id="auditStatusText">In Bearbeitung</strong>
</div>
<div class="progress-container">
<div class="progress-bar">
<div class="progress-fill" id="progressFill" style="width: 0%"></div>
<div class="progress-text" id="progressText">0%</div>
</div>
</div>
</div>
</div>

<!-- Gesamtergebnis -->
<div id="finalResult" class="final-result">
<div id="resultIcon" style="font-size: 1.2em; margin-bottom: 5px;"></div>
<div id="resultText" style="font-size: 0.9em;"></div>
</div>

<!-- Desktop Ansicht -->
<div class="desktop-view" id="desktopView">
<div id="auditSections"></div>
</div>

<!-- Mobile Ansicht -->
<div class="mobile-view" id="mobileView">
<div class="mobile-section-selector" id="sectionSelector"></div>
<div id="mobileQuestions"></div>
<div class="mobile-nav">
<button class="btn-secondary" id="prevBtn">‚Üê Zur√ºck</button>
<span id="mobileCounter">1/1</span>
<button class="btn-secondary" id="nextBtn">Weiter ‚Üí</button>
</div>
</div>
</div>

<!-- MITARBEITERLISTE SEITE -->
<div id="employeeListView" class="employee-view">
<div class="controls-row-1">
<button class="btn-back" id="backFromEmployeesBtn">‚Üê Zur√ºck</button>
<button class="btn-success" id="addEmployeeBtn">‚ûï Mitarbeiter hinzuf√ºgen</button>
<button class="btn-export" id="refreshAuditsBtn">üîÑ Audits aktualisieren</button>
<button class="btn-export" id="importEmployeeListBtn">üì• Liste importieren</button>
<button class="btn-authorization" id="syncCloudBtn">‚òÅÔ∏è Cloud Sync</button>
</div>
<div class="employee-controls" style="display:flex; gap:6px; align-items:center; flex-wrap: wrap;">
<input type="text" id="employeeSearch" class="employee-search" placeholder="üîç Name oder Personalnummer suchen..." style="flex:1; min-width:200px; padding:6px; border:1px solid #ccc; border-radius:4px;">
<select id="auditStatusFilter" class="employee-filter" style="padding:6px; border:1px solid #ccc; border-radius:4px;">
<option value="all">Alle Status</option>
<option value="valid">‚úÖ G√ºltig</option>
<option value="expired">‚ùå Abgelaufen</option>
<option value="warning">‚ö†Ô∏è L√§uft bald ab</option>
<option value="missing">‚≠ï Kein Audit</option>
</select>
<select id="glassesFilter" class="employee-filter" style="padding:6px; border:1px solid #ccc; border-radius:4px;">
<option value="all">Alle Brillen</option>
<option value="yes">üëì Mit Brille</option>
<option value="no">‚ùå Ohne Brille</option>
</select>
<button class="btn-secondary" id="clearFiltersBtn">Filter l√∂schen</button>
</div>
<div style="overflow-x: auto; margin-top: 10px; width: 100%; -webkit-overflow-scrolling: touch;">
<table id="employeeTable" class="employee-table">
<thead>
<tr>
<th style="width: 80px;">Status</th>
<th style="width: 120px;">Name</th>
<th style="width: 90px;">Personal-Nr.</th>
<th style="width: 70px;">Brille</th>
<th style="width: 90px;">Ident.-Nr.</th>
<th style="width: 90px;">Datum Sehtest</th>
<th style="width: 100px;">Letztes Audit</th>
<th style="width: 100px;">N√§chstes Audit</th>
<th style="min-width: 120px;">Verfahren</th>
<th style="width: 150px;">Aktionen</th>
</tr>
</thead>
<tbody id="employeeTableBody"></tbody>
</table>
</div>
<div class="stats-container" style="display:flex; gap:6px; flex-wrap: wrap; margin-top: 8px;">
<div class="stat-box" style="background: #d4edda; padding:8px; border-radius:6px;">
<div class="stat-value" id="statValid" style="font-weight:700;">0</div>
<div>‚úÖ G√ºltig</div>
</div>
<div class="stat-box" style="background: #f8d7da; padding:8px; border-radius:6px;">
<div class="stat-value" id="statExpired" style="font-weight:700;">0</div>
<div>‚ùå Abgelaufen</div>
</div>
<div class="stat-box" style="background: #fff3cd; padding:8px; border-radius:6px;">
<div class="stat-value" id="statWarning" style="font-weight:700;">0</div>
<div>‚ö†Ô∏è L√§uft bald ab</div>
</div>
<div class="stat-box" style="background: #e2e3e5; padding:8px; border-radius:6px;">
<div class="stat-value" id="statMissing" style="font-weight:700;">0</div>
<div>‚≠ï Kein Audit</div>
</div>
<div class="stat-box" style="background: #f0f0f0; padding:8px; border-radius:6px;">
<div class="stat-value" id="statTotal" style="font-weight:700;">0</div>
<div>üë• Gesamt</div>
</div>
</div>
</div>

<footer>
<p>Operator Audit Tool - Schaeffler Technologies AG & Co. KG</p>
<div class="version-info">Version AB - 29.01.2026 | Cloud-Sync aktiv</div>
<div class="creator-info">Ersteller: H√§usner Daniel, WI/SW2-PQT</div>
</footer>
</div>

<!-- BERICHTS OVERLAY -->
<div id="reportOverlay" class="report-overlay">
<div class="report-container" id="reportContainer">
<!-- Aktions-Buttons -->
<div class="report-action-buttons">
<button class="report-action-btn cloud-btn" onclick="saveReportToCloud()">‚òÅÔ∏è Cloud</button>
<button class="report-action-btn print-btn" onclick="printFullReport()">üñ®Ô∏è</button>
<button class="report-action-btn close-btn" onclick="closeReport()">‚úï</button>
</div>
<!-- Bericht wird hier dynamisch eingef√ºgt -->
</div>
</div>

<!-- AUTORISIERUNGS OVERLAY -->
<div id="authorizationOverlay" class="report-overlay">
<div class="report-container" id="authorizationContainer">
<!-- Aktions-Buttons -->
<div class="report-action-buttons">
<button class="report-action-btn cloud-btn" onclick="saveAuthorizationToCloud()">‚òÅÔ∏è Cloud</button>
<button class="report-action-btn print-btn" onclick="printFullAuthorization()">üñ®Ô∏è</button>
<button class="report-action-btn close-btn" onclick="closeAuthorization()">‚úï</button>
</div>
<!-- Autorisierung wird hier dynamisch eingef√ºgt -->
</div>
</div>

<!-- VERSTECKTE INPUTS -->
<input type="file" id="fileLoader" accept=".json" style="display: none;">
<input type="file" id="questionsLoader" accept=".json" style="display: none;">
<input type="file" id="employeeListLoader" accept=".json" style="display: none;">
<input type="file" id="cloudRestoreLoader" accept=".json" style="display: none;">

<!-- SUPABASE SCRIPT -->
<script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2.39.7/dist/umd/supabase.min.js"></script>

<script>
// === SUPABASE KONFIGURATION ===
const SUPABASE_URL = 'https://wqrynlgbspkjzxuxauvq.supabase.co';
const SUPABASE_ANON_KEY = 'sb_publishable_jkkaIcAKxMhkXSdnJY1Oiw_U-xPWr68';
const SUPABASE_PASSWORD = 'ZfPReviewAudit';
let supabase;
let cloudConnected = false;
let cloudSyncInProgress = false;

// === KONSTANTEN ===
const AUDIT_TYPES = {
wirbelstrom: { id: 'wirbelstrom', title: 'Wirbelstrompr√ºfung', short: 'ET', color: '#3498db', icon: '‚ö°', norm: '', instruction: '' },
magnetpulver: { id: 'magnetpulver', title: 'Magnetpulverpr√ºfung', short: 'MT', color: '#e74c3c', icon: 'üß≤', norm: '', instruction: '' },
nital:       { id: 'nital',       title: 'Nital-√Ñtzen',        short: 'NE', color: '#2ecc71', icon: 'üß™', norm: '', instruction: '' },
ultraschall: { id: 'ultraschall', title: 'Ultraschallpr√ºfung', short: 'UT', color: '#9b59b6', icon: 'üì°', norm: '', instruction: '' }
};
const STORAGE_LIST_KEY = (type) => `zfpAudit_${type}_list`;

const STANDARD_QUESTIONS = {
wirbelstrom: [
{ title: "1. Qualifikation & Dokumentation", short: "Qualifikation",
questions: [
{ id: "ET-1.1", text: "Sehtest g√ºltig (‚â§12 Monate) und Zertifikat vorgelegt", english: "Eye test valid (‚â§12 months) and certificate presented" },
{ id: "ET-1.2", text: "ET Zertifikat ISO/ASNT-konform vorhanden", english: "ET  certificate ISO/ASNT compliant available" },
{ id: "ET-1.3", text: "Kenntnis der Norm S285066 und Arbeitsanweisung INFSW_17005 nachgewiesen", english: "Knowledge of standard S285066 and work instruction INFSW_17005 demonstrated" }
] },
{ title: "2. Ger√§teeinrichtung & Kalibrierung", short: "Ger√§tepr√ºfung",
questions: [
{ id: "ET-2.1", text: "T√§gliche Plausibilit√§tspr√ºfung korrekt durchgef√ºhrt und dokumentiert", english: "Daily plausibility check correctly performed and documented" },
{ id: "ET-2.2", text: "Referenzteile gem√§√ü Norm vorhanden und korrekt gelagert", english: "Reference parts according to standard available and correctly stored" },
{ id: "ET-2.3", text: "Ger√§teparameter entsprechend Pr√ºfanweisung eingestellt", english: "Device parameters set according to inspection instruction" }
] },
{ title: "3. Pr√ºfdurchf√ºhrung & Bewertung", short: "Pr√ºfung",
questions: [
{ id: "ET-3.1", text: "Systematische Pr√ºfung aller definierten Bereiche", english: "Systematic inspection of all defined areas" },
{ id: "ET-3.2", text: "Korrekte Erkennung und Bewertung von Fehleranzeigen", english: "Correct detection and evaluation of defect indications" },
{ id: "ET-3.3", text: "n.i.O.-Teile korrekt erkannt und als 'nicht i.O.' deklariert", english: "Rejected parts correctly identified and declared as 'not OK'" },
{ id: "ET-3.4", text: "Keine Fehlbewertungen (gute Teile als n.i.O. deklariert)", english: "No false rejections (good parts declared as not OK)" }
] },
{ title: "4. Dokumentation & Qualit√§tssicherung", short: "Dokumentation",
questions: [
{ id: "ET-4.1", text: "Vollst√§ndige und lesbare Dokumentation aller Pr√ºfergebnisse", english: "Complete and legible documentation of all test results" },
{ id: "ET-4.2", text: "Korrekte Anwendung des Zwischenbeh√§lter-Prinzips (Trennung i.O./n.i.O.)", english: "Correct application of intermediate container principle (separation OK/not OK)" },
{ id: "ET-4.3", text: "Entmagnetisierung bei Bedarf durchgef√ºhrt und Grenzwerte kontrolliert", english: "Demagnetization performed when required and limit values controlled" },
{ id: "ET-4.4", text: "T√§tigkeitsnachweis vorhanden und vollst√§ndig dokumentiert", english: "Activity proof available and fully documented", isActivityProof: true }
] }
],
magnetpulver: [
{ title: "1. Qualifikation & Normenkenntnis", short: "Qualifikation",
questions: [
{ id: "MT-1.1", text: "Sehtest g√ºltig (‚â§12 Monate) und dokumentiert", english: "Eye test valid (‚â§12 months) and documented" },
{ id: "MT-1.2", text: "MT  Zertifikat ISO/IASNT-konform vorhanden", english: "MT  certificate ISO/IASNT compliant available" },
{ id: "MT-1.3", text: "Kenntnis Normen (DIN EN ISO 9934, S24000-8) und Arbeitsanweisung INFSW01044", english: "Knowledge of standards (DIN EN ISO 9934, S24000-8) and work instruction INFSW01044" }
] },
{ title: "2. Ger√§tepr√ºfung & Kalibrierung", short: "Ger√§tepr√ºfung",
questions: [
{ id: "MT-2.1", text: "UV-Lampe √ºberpr√ºft (Intensit√§t, Filter) und dokumentiert", english: "UV lamp checked (intensity, filter) and documented" },
{ id: "MT-2.2", text: "UV- und Belichtungsmesser gem√§√ü Vorgabe kalibriert", english: "UV and lux meter calibrated according to specification" },
{ id: "MT-2.3", text: "Magnetisierung f√ºr alle Ausrichtungen gepr√ºft, Grenzwerte eingehalten", english: "Magnetization checked for all orientations, limit values maintained" },
{ id: "MT-2.4", text: "MTU-Pr√ºfk√∂rper 3 Kontrolle durchgef√ºhrt", english: "MTU test body 3 control performed" }
] },
{ title: "3. Pr√ºfdurchf√ºhrung & Fehlererkennung", short: "Pr√ºfung",
questions: [
{ id: "MT-3.1", text: "Vollst√§ndige Inspektion aller relevanten Oberfl√§chen", english: "Complete inspection of all relevant surfaces" },
{ id: "MT-3.2", text: "Korrekte Interpretation von Rissanzeigen", english: "Correct interpretation of crack indications" },
{ id: "MT-3.3", text: "n.i.O.-Teile korrekt erkannt und als 'nicht i.O.' deklariert", english: "Rejected parts correctly identified and declared as 'not OK'" },
{ id: "MT-3.4", text: "Keine Fehlbewertungen (falsche Interpretationen)", english: "No mis-evaluations (false interpretations)" }
] },
{ title: "4. Dokumentation & Qualit√§tssicherung", short: "Dokumentation",
questions: [
{ id: "MT-4.1", text: "Korrekte Verwendung der Dokumentationsvorlage", english: "Correct use of documentation template" },
{ id: "MT-4.2", text: "Lesbare Dokumentation aller Indikationen und Ma√ünahmen", english: "Legible documentation of all indications and measures" },
{ id: "MT-4.3", text: "Entmagnetisierung korrekt durchgef√ºhrt und dokumentiert", english: "Demagnetization correctly performed and documented" },
{ id: "MT-4.4", text: "T√§tigkeitsnachweis vorhanden und vollst√§ndig dokumentiert", english: "Activity proof available and fully documented", isActivityProof: true }
] }
],
ultraschall: [
{ title: "1. Qualifikation & Normenkenntnis", short: "Qualifikation",
questions: [
{ id: "UT-1.1", text: "Sehtest g√ºltig (‚â§12 Monate) und dokumentiert", english: "Eye test valid (‚â§12 months) and documented" },
{ id: "UT-1.2", text: "UT  Zertifikat ISO/ASNT-konform vorhanden", english: "UT  certificate ISO/ASNT compliant available" },
{ id: "UT-1.3", text: "Kenntnis Normen (DIN EN ISO 22232, S231202-5) und Arbeitsanweisungen", english: "Knowledge of standards (DIN EN ISO 22232, S231202-5) and work instructions" }
] },
{ title: "2. Kalibrierung & Ger√§teeinstellung", short: "Kalibrierung",
questions: [
{ id: "UT-2.1", text: "Sensitivit√§tskalibrierung gem√§√ü Norm durchgef√ºhrt", english: "Sensitivity calibration performed according to standard" },
{ id: "UT-2.2", text: "Distanzkalibrierung gem√§√ü Norm durchgef√ºhrt", english: "Distance calibration performed according to standard" },
{ id: "UT-2.3", text: "Ger√§teeinrichtung korrekt demonstriert", english: "Device setup correctly demonstrated" }
] },
{ title: "3. Pr√ºfdurchf√ºhrung & Defekterkennung", short: "Pr√ºfung",
questions: [
{ id: "UT-3.1", text: "Systematische Pr√ºfung aller vorgegebenen Bereiche", english: "Systematic inspection of all specified areas" },
{ id: "UT-3.2", text: "Korrekte R√ºckkehr zum gr√∂√üten Defekt f√ºr Messung", english: "Correct return to largest defect for measurement" },
{ id: "UT-3.3", text: "Genauigkeit der Tiefenmessung und Dimensionierung", english: "Accuracy of depth measurement and dimensioning" },
{ id: "UT-3.4", text: "n.i.O.-Teile korrekt erkannt und als 'nicht i.O.' deklariert", english: "Rejected parts correctly identified and declared as 'not OK'" }
] },
{ title: "4. Dokumentation & Qualit√§tssicherung", short: "Dokumentation",
questions: [
{ id: "UT-4.1", text: "Dokumentation gem√§√ü Arbeitsanweisung korrekt durchgef√ºhrt", english: "Documentation according to work instruction correctly performed" },
{ id: "UT-4.2", text: "Vollst√§ndige Aufzeichnung aller Pr√ºfergebnisse", english: "Complete recording of all test results" },
{ id: "UT-4.3", text: "Klare Kennzeichnung und Trennung von n.i.O.-Teilen", english: "Clear marking and separation of rejected parts" },
{ id: "UT-4.4", text: "T√§tigkeitsnachweis vorhanden und vollst√§ndig dokumentiert", english: "Activity proof available and fully documented", isActivityProof: true }
] }
],
nital: [
{ title: "1. Qualifikation & Sicherheit", short: "Qualifikation",
questions: [
{ id: "NE-1.1", text: "Sehtest g√ºltig (‚â§12 Monate) und dokumentiert", english: "Eye test valid (‚â§12 months) and documented" },
{ id: "NE-1.2", text: "Zertifikat f√ºr Nital-√Ñtzen vorhanden", english: "Certificate for nital etching available" },
{ id: "NE-1.3", text: "Sicherheitsunterweisung f√ºr S√§urehandhabung nachgewiesen", english: "Safety training for acid handling demonstrated" }
] },
{ title: "2. Prozesskontrolle & Chemikalien", short: "Prozesskontrolle",
questions: [
{ id: "NE-2.1", text: "Reinigungsprozess entspricht Norm (Parameter, Ultraschall)", english: "Cleaning process complies with standard (parameters, ultrasonic)" },
{ id: "NE-2.2", text: "√Ñtzmittel korrekt gelagert und √ºberwacht (chemische Analyse)", english: "Etching agent correctly stored and monitored (chemical analysis)" },
{ id: "NE-2.3", text: "√Ñtzparameter entsprechend Arbeitsanweisung eingehalten", english: "Etching parameters maintained according to work instruction" }
] },
{ title: "3. Pr√ºfung & Bewertung", short: "Pr√ºfung",
questions: [
{ id: "NE-3.1", text: "Systematische Inspektion der ge√§tzten Fl√§chen", english: "Systematic inspection of etched surfaces" },
{ id: "NE-3.2", text: "Korrekte Bewertung von Gef√ºgestrukturen und Anomalien", english: "Correct evaluation of microstructure and anomalies" },
{ id: "NE-3.3", text: "n.i.O.-Teile korrekt erkannt und als 'nicht i.O.' deklariert", english: "Rejected parts correctly identified and declared as 'not OK'" },
{ id: "NE-3.4", text: "Unterscheidung zwischen relevanten und nicht relevanten Anzeigen", english: "Differentiation between relevant and non-relevant indications" }
] },
{ title: "4. Dokumentation & Nachverfolgbarkeit", short: "Dokumentation",
questions: [
{ id: "NE-4.1", text: "Vollst√§ndige Dokumentation aller Prozessparameter", english: "Complete documentation of all process parameters" },
{ id: "NE-4.2", text: "Nachweis der korrekten √Ñtzung (Bilder/Dokumentation)", english: "Proof of correct etching (pictures/documentation)" },
{ id: "NE-4.3", text: "Trennung von i.O. und n.i.O. Teilen gew√§hrleistet", english: "Separation of OK and not OK parts ensured" },
{ id: "NE-4.4", text: "T√§tigkeitsnachweis vorhanden und vollst√§ndig dokumentiert", english: "Activity proof available and fully documented", isActivityProof: true }
] }
]
};

// === GLOBALE VARIABLEN ===
let currentAuditType = null;
let currentAuditData = null;
let allQuestions = [];
let currentMobileQuestion = 0;
let imageStorage = {};
let uploadedImages = new Set();
let customModalResolve = null;

// Mitarbeiterliste Variablen
let employees = [];
let employeeAudits = [];
let currentEmployeeEditId = null;
let currentAuditListEmployeeId = null;
let employeeSearchFilter = '';
let statusFilter = 'all';
let glassesFilter = 'all';

// Audit-√úberpr√ºfungsstatus
let auditReviews = {};

// === SUPABASE FUNKTIONEN ===

async function initSupabase() {
    try {
        supabase = window.supabase.createClient(SUPABASE_URL, SUPABASE_ANON_KEY);
        console.log('Supabase Client initialisiert');
        
        // Test-Verbindung
        const { data, error } = await supabase.from('zfp_audits').select('count').limit(1);
        if (error) {
            console.log('Supabase-Verbindungstest:', error.message);
            // Versuche Tabellen zu erstellen
            await createSupabaseTables();
        } else {
            cloudConnected = true;
            updateCloudStatus();
            console.log('Cloud verbunden');
        }
        
        return true;
    } catch (error) {
        console.error('Fehler bei Supabase-Initialisierung:', error);
        cloudConnected = false;
        updateCloudStatus();
        return false;
    }
}

async function createSupabaseTables() {
    try {
        console.log('Erstelle Supabase Tabellen...');
        
        // Tabelle f√ºr Audits mit vollst√§ndigem Inhalt
        const { error: auditsError } = await supabase
            .from('zfp_audits')
            .insert({
                id: 'table_check',
                audit_type: 'test',
                data: { test: true },
                created_at: new Date().toISOString(),
                updated_at: new Date().toISOString()
            })
            .select();
            
        if (auditsError && auditsError.code === '42P01') {
            console.log('Tabelle zfp_audits existiert nicht - wird automatisch erstellt');
        }
        
        // Tabelle f√ºr Mitarbeiter
        const { error: employeesError } = await supabase
            .from('zfp_employees')
            .insert({
                id: 'table_check',
                name: 'Test',
                status: 'missing',
                created_at: new Date().toISOString(),
                updated_at: new Date().toISOString()
            })
            .select();
            
        if (employeesError && employeesError.code === '42P01') {
            console.log('Tabelle zfp_employees existiert nicht - wird automatisch erstellt');
        }
        
        // Tabelle f√ºr Berichte/PDFs
        const { error: reportsError } = await supabase
            .from('zfp_reports')
            .insert({
                id: 'table_check',
                type: 'test',
                title: 'Test',
                content: 'Test',
                created_at: new Date().toISOString()
            })
            .select();
            
        if (reportsError && reportsError.code === '42P01') {
            console.log('Tabelle zfp_reports existiert nicht - wird automatisch erstellt');
        }
        
        cloudConnected = true;
        updateCloudStatus();
        return true;
    } catch (error) {
        console.error('Fehler beim Erstellen der Tabellen:', error);
        return false;
    }
}

async function saveReportToCloud() {
    if (!cloudConnected) {
        showInfoModal('‚ùå Keine Cloud-Verbindung');
        return false;
    }
    
    try {
        const reportContainer = document.getElementById('reportContainer');
        const reportContent = reportContainer.innerHTML;
        
        // Extrahiere Berichtsinformationen
        const titleMatch = reportContent.match(/<h2[^>]*>([^<]+)<\/h2>/);
        const reportTitle = titleMatch ? titleMatch[1] : 'Audit-Bericht';
        
        const reportNumberMatch = reportContent.match(/<strong>Pr√ºfbericht-Nr\.:<\/strong> ([^<]+)/);
        const reportNumber = reportNumberMatch ? reportNumberMatch[1].trim() : 'Unbekannt';
        
        // Speichere Bericht in Cloud
        const reportData = {
            id: `report_${Date.now()}_${Math.random().toString(36).substr(2, 9)}`,
            type: 'audit_report',
            title: reportTitle,
            report_number: reportNumber,
            content: reportContent,
            created_at: new Date().toISOString(),
            device_id: 'web_' + navigator.userAgent.substring(0, 30)
        };
        
        const { error } = await supabase
            .from('zfp_reports')
            .insert(reportData);
        
        if (error) {
            console.error('Fehler beim Speichern des Berichts:', error);
            showInfoModal('‚ùå Bericht konnte nicht in Cloud gespeichert werden');
            return false;
        }
        
        showInfoModal('‚úÖ Bericht in Cloud gespeichert');
        return true;
    } catch (error) {
        console.error('Fehler bei saveReportToCloud:', error);
        showInfoModal('‚ùå Fehler beim Speichern in Cloud');
        return false;
    }
}

async function saveAuthorizationToCloud() {
    if (!cloudConnected) {
        showInfoModal('‚ùå Keine Cloud-Verbindung');
        return false;
    }
    
    try {
        const authorizationContainer = document.getElementById('authorizationContainer');
        const authorizationContent = authorizationContainer.innerHTML;
        
        // Extrahiere Autorisierungsinformationen
        const titleMatch = authorizationContent.match(/<h1[^>]*>([^<]+)<\/h1>/);
        const authTitle = titleMatch ? titleMatch[1] : 'Autorisierung';
        
        const nameMatch = authorizationContent.match(/<strong>Name:<\/strong> ([^<]+)/);
        const employeeName = nameMatch ? nameMatch[1].trim() : 'Unbekannt';
        
        // Speichere Autorisierung in Cloud
        const authData = {
            id: `auth_${Date.now()}_${Math.random().toString(36).substr(2, 9)}`,
            type: 'authorization',
            title: authTitle,
            employee_name: employeeName,
            content: authorizationContent,
            created_at: new Date().toISOString(),
            device_id: 'web_' + navigator.userAgent.substring(0, 30)
        };
        
        const { error } = await supabase
            .from('zfp_reports')
            .insert(authData);
        
        if (error) {
            console.error('Fehler beim Speichern der Autorisierung:', error);
            showInfoModal('‚ùå Autorisierung konnte nicht in Cloud gespeichert werden');
            return false;
        }
        
        showInfoModal('‚úÖ Autorisierung in Cloud gespeichert');
        return true;
    } catch (error) {
        console.error('Fehler bei saveAuthorizationToCloud:', error);
        showInfoModal('‚ùå Fehler beim Speichern in Cloud');
        return false;
    }
}

async function syncSingleAuditToCloud(auditData) {
    if (!cloudConnected || !auditData) return false;
    
    try {
        const cloudAudit = {
            id: auditData.meta.instanceId,
            audit_type: auditData.meta.auditType,
            data: auditData,
            operator_name: auditData.headerData?.operatorName || '',
            operator_number: auditData.headerData?.operatorNumber || '',
            report_number: auditData.headerData?.reportNumber || '',
            created_at: auditData.meta.created || new Date().toISOString(),
            updated_at: new Date().toISOString(),
            device_id: 'web_' + navigator.userAgent.substring(0, 30)
        };
        
        const { error } = await supabase
            .from('zfp_audits')
            .upsert(cloudAudit, { onConflict: 'id' });
            
        if (error) {
            console.warn('Auto-Sync Audit fehlgeschlagen:', error);
            return false;
        }
        
        console.log('Audit auto-sync erfolgreich:', auditData.meta.instanceId);
        return true;
    } catch (error) {
        console.error('Fehler bei Auto-Sync Audit:', error);
        return false;
    }
}

async function syncSingleEmployeeToCloud(employee) {
    if (!cloudConnected || !employee) return false;
    
    try {
        const auditsJson = employee.audits ? JSON.stringify(employee.audits) : '[]';
        const authorizationsJson = employee.authorizations ? JSON.stringify(employee.authorizations) : '[]';
        
        const empData = {
            id: employee.id,
            name: employee.name || '',
            number: employee.number || '',
            birthdate: employee.birthdate || '',
            eye_test_date: employee.eyeTestDate || '',
            cert_number: employee.certNumber || '',
            glasses: employee.glasses || 'unknown',
            department: employee.department || '',
            certificate: employee.certificate || '',
            notes: employee.notes || '',
            status: employee.status || 'missing',
            audits: auditsJson,
            authorizations: authorizationsJson,
            latest_audit: employee.latestAudit ? employee.latestAudit.date.toISOString() : null,
            next_audit: employee.nextAudit ? employee.nextAudit.toISOString() : null,
            created_at: employee.created || new Date().toISOString(),
            updated_at: new Date().toISOString(),
            device_id: 'web_' + navigator.userAgent.substring(0, 30)
        };
        
        await supabase
            .from('zfp_employees')
            .upsert(empData, { onConflict: 'id' });
        
        console.log('Mitarbeiter auto-sync erfolgreich:', employee.name);
        return true;
    } catch (error) {
        console.error('Fehler bei Auto-Sync Mitarbeiter:', error);
        return false;
    }
}

async function syncFromCloud() {
    if (!cloudConnected) {
        const success = await initSupabase();
        if (!success) {
            showInfoModal('‚ùå Keine Cloud-Verbindung');
            return false;
        }
    }
    
    try {
        showInfoModal('üîÑ Synchronisiere von Cloud...');
        
        // 1. Audits von Cloud laden
        const { data: cloudAudits, error: auditsError } = await supabase
            .from('zfp_audits')
            .select('*')
            .order('created_at', { ascending: false });
        
        if (auditsError) {
            console.error('Fehler beim Laden der Audits:', auditsError);
        } else if (cloudAudits && cloudAudits.length > 0) {
            // Cloud-Audits lokal speichern
            cloudAudits.forEach(cloudAudit => {
                if (cloudAudit.audit_type && cloudAudit.data) {
                    const listKey = STORAGE_LIST_KEY(cloudAudit.audit_type);
                    let localList = [];
                    const saved = localStorage.getItem(listKey);
                    if (saved) {
                        try {
                            localList = JSON.parse(saved) || [];
                        } catch (e) {
                            localList = [];
                        }
                    }
                    
                    // Pr√ºfen ob Audit bereits existiert
                    const exists = localList.some(a => a.meta?.instanceId === cloudAudit.id);
                    if (!exists) {
                        localList.push(cloudAudit.data);
                        localStorage.setItem(listKey, JSON.stringify(localList));
                    }
                }
            });
        }
        
        // 2. Mitarbeiter von Cloud laden
        const { data: cloudEmployees, error: employeesError } = await supabase
            .from('zfp_employees')
            .select('*')
            .order('updated_at', { ascending: false });
        
        if (employeesError) {
            console.error('Fehler beim Laden der Mitarbeiter:', employeesError);
        } else if (cloudEmployees && cloudEmployees.length > 0) {
            // Mitarbeiter in lokale Liste √ºbernehmen
            const newEmployees = cloudEmployees.map(emp => {
                // Audits aus JSON parsen
                let audits = [];
                try {
                    audits = emp.audits ? JSON.parse(emp.audits) : [];
                } catch (e) {
                    audits = [];
                }
                
                // Authorizations aus JSON parsen
                let authorizations = [];
                try {
                    authorizations = emp.authorizations ? JSON.parse(emp.authorizations) : [];
                } catch (e) {
                    authorizations = [];
                }
                
                return {
                    id: emp.id,
                    name: emp.name || '',
                    number: emp.number || '',
                    birthdate: emp.birthdate || '',
                    eyeTestDate: emp.eye_test_date || '',
                    certNumber: emp.cert_number || '',
                    glasses: emp.glasses || 'unknown',
                    department: emp.department || '',
                    certificate: emp.certificate || '',
                    notes: emp.notes || '',
                    created: emp.created_at || new Date().toISOString(),
                    updated: emp.updated_at || new Date().toISOString(),
                    audits: audits,
                    authorizations: authorizations,
                    status: emp.status || 'missing'
                };
            });
            
            // Mit lokalen Mitarbeitern mergen
            employees = mergeEmployees(employees, newEmployees);
            localStorage.setItem('zfpEmployees', JSON.stringify(employees));
        }
        
        // 3. Audit Reviews von Cloud laden
        const { data: cloudReviews, error: reviewsError } = await supabase
            .from('zfp_audit_reviews')
            .select('*');
        
        if (!reviewsError && cloudReviews) {
            cloudReviews.forEach(review => {
                auditReviews[review.audit_id] = {
                    reviewed: review.reviewed,
                    reviewedDate: review.reviewed_date
                };
            });
            localStorage.setItem('zfpAuditReviews', JSON.stringify(auditReviews));
        }
        
        // Daten neu laden
        loadAuditFiles();
        renderEmployeeList();
        updateEmployeeStatus();
        
        showInfoModal(`‚úÖ Sync abgeschlossen\nAudits: ${cloudAudits?.length || 0}\nMitarbeiter: ${cloudEmployees?.length || 0}`);
        return true;
        
    } catch (error) {
        console.error('Fehler bei Cloud-Sync:', error);
        showInfoModal('‚ùå Fehler bei Cloud-Synchronisation');
        return false;
    }
}

function mergeEmployees(localEmployees, cloudEmployees) {
    const merged = [...localEmployees];
    
    cloudEmployees.forEach(cloudEmp => {
        const existingIndex = merged.findIndex(localEmp => localEmp.id === cloudEmp.id);
        
        if (existingIndex >= 0) {
            // Merge: Cloud-Daten haben Priorit√§t wenn neuer
            const localEmp = merged[existingIndex];
            const localUpdated = new Date(localEmp.updated || 0);
            const cloudUpdated = new Date(cloudEmp.updated || 0);
            
            if (cloudUpdated > localUpdated) {
                merged[existingIndex] = {
                    ...localEmp,
                    ...cloudEmp,
                    // Behalte lokale IDs bei
                    id: localEmp.id
                };
            }
        } else {
            // Neuer Mitarbeiter aus Cloud
            merged.push(cloudEmp);
        }
    });
    
    return merged;
}

async function syncAllToCloud() {
    if (!cloudConnected) {
        const success = await initSupabase();
        if (!success) {
            showInfoModal('‚ùå Keine Cloud-Verbindung');
            return false;
        }
    }
    
    try {
        cloudSyncInProgress = true;
        showInfoModal('üîÑ Synchronisiere mit Cloud...');
        
        // 1. Mitarbeiter hochladen
        for (const employee of employees) {
            await syncSingleEmployeeToCloud(employee);
        }
        
        // 2. Audits hochladen
        await syncAuditsToCloud();
        
        // 3. Reviews hochladen
        const reviewsForCloud = Object.entries(auditReviews).map(([auditId, review]) => ({
            audit_id: auditId,
            reviewed: review.reviewed,
            reviewed_date: review.reviewedDate,
            device_id: 'web_' + navigator.userAgent.substring(0, 30)
        }));
        
        if (reviewsForCloud.length > 0) {
            await supabase
                .from('zfp_audit_reviews')
                .upsert(reviewsForCloud, { onConflict: 'audit_id' });
        }
        
        cloudSyncInProgress = false;
        showInfoModal('‚úÖ Alle Daten in Cloud gespeichert');
        return true;
        
    } catch (error) {
        cloudSyncInProgress = false;
        console.error('Fehler bei Komplettsync:', error);
        showInfoModal('‚ùå Fehler bei Cloud-Synchronisation');
        return false;
    }
}

// === CLOUD UI FUNKTIONEN ===

function updateCloudStatus() {
    const statusElement = document.getElementById('cloudStatus');
    if (statusElement) {
        if (cloudConnected) {
            statusElement.innerHTML = 'üåê Cloud verbunden';
            statusElement.style.color = '#27ae60';
        } else {
            statusElement.innerHTML = '‚ùå Cloud nicht verbunden';
            statusElement.style.color = '#e74c3c';
        }
    }
}

// === UTILITY FUNKTIONEN ===
function daysBetween(d1, d2) {
const msPerDay = 1000 * 60 * 60 * 24;
const a = new Date(d1.getFullYear(), d1.getMonth(), d1.getDate());
const b = new Date(d2.getFullYear(), d2.getMonth(), d2.getDate());
return Math.floor((b - a) / msPerDay);
}

function parseGermanDate(dateStr) {
if (!dateStr) return null;
const parts = dateStr.split('.');
if (parts.length === 3) {
const day = parseInt(parts[0], 10);
const month = parseInt(parts[1], 10) - 1;
const year = parseInt(parts[2], 10);
return new Date(year, month, day);
}
return null;
}

function formatGermanDate(date) {
if (!date) return '';
const d = new Date(date);
const day = d.getDate().toString().padStart(2, '0');
const month = (d.getMonth() + 1).toString().padStart(2, '0');
const year = d.getFullYear();
return `${day}.${month}.${year}`;
}

// === MODAL FUNKTIONEN ===
function showCustomModal(message) {
return new Promise((resolve) => {
document.getElementById('modalMessage').textContent = message;
document.getElementById('customModal').style.display = 'flex';
customModalResolve = resolve;
});
}
function closeCustomModal() {
document.getElementById('customModal').style.display = 'none';
customModalResolve = null;
}
function showInfoModal(message, timeout = 1500) {
const modal = document.getElementById('customModal');
const confirmBtn = document.getElementById('modalConfirmBtn');
const cancelBtn = document.getElementById('modalCancelBtn');
document.getElementById('modalMessage').textContent = message;
confirmBtn.style.display = 'none';
cancelBtn.style.display = 'none';
modal.style.display = 'flex';
setTimeout(() => {
confirmBtn.style.display = '';
cancelBtn.style.display = '';
closeCustomModal();
}, timeout);
}

// === MITARBEITERLISTE FUNKTIONEN ===
async function loadEmployees() {
try {
const saved = localStorage.getItem('zfpEmployees');
employees = saved ? JSON.parse(saved) : [];
employees.forEach(emp => {
if (!emp.birthdate) emp.birthdate = '';
if (!emp.eyeTestDate) emp.eyeTestDate = '';
if (!emp.certNumber) emp.certNumber = '';
if (!emp.authorizations) emp.authorizations = [];
});
} catch (e) {
console.error('Fehler beim Laden der Mitarbeiter:', e);
employees = [];
}
}
async function saveEmployees() {
try {
localStorage.setItem('zfpEmployees', JSON.stringify(employees));
updateEmployeeStatus();

// AUTOMATISCHE Cloud-Sync SOFORT
if (cloudConnected && !cloudSyncInProgress) {
for (const employee of employees) {
await syncSingleEmployeeToCloud(employee);
}
}
} catch (e) {
console.error('Fehler beim Speichern der Mitarbeiter:', e);
}
}

async function loadAuditReviews() {
try {
const saved = localStorage.getItem('zfpAuditReviews');
auditReviews = saved ? JSON.parse(saved) : {};
} catch (e) {
console.error('Fehler beim Laden der Audit-Reviews:', e);
auditReviews = {};
}
}

async function saveAuditReviews() {
try {
localStorage.setItem('zfpAuditReviews', JSON.stringify(auditReviews));

// AUTOMATISCHE Cloud-Sync
if (cloudConnected && !cloudSyncInProgress) {
const reviewsForCloud = Object.entries(auditReviews).map(([auditId, review]) => ({
audit_id: auditId,
reviewed: review.reviewed,
reviewed_date: review.reviewedDate,
device_id: 'web_' + navigator.userAgent.substring(0, 30)
}));

if (reviewsForCloud.length > 0) {
await supabase
.from('zfp_audit_reviews')
.upsert(reviewsForCloud, { onConflict: 'audit_id' });
}
}
} catch (e) {
console.error('Fehler beim Speichern der Audit-Reviews:', e);
}
}

async function markAuditAsReviewed(auditId) {
auditReviews[auditId] = {
reviewed: true,
reviewedDate: new Date().toISOString()
};
await saveAuditReviews();
}

async function unmarkAuditAsReviewed(auditId) {
delete auditReviews[auditId];
await saveAuditReviews();
}

function isAuditReviewed(auditId) {
return auditReviews[auditId]?.reviewed || false;
}

function addAuditToEmployee(employee, audit) {
const auditDate = audit.meta?.created ? new Date(audit.meta.created) : new Date();
const expiryDate = new Date(auditDate);
expiryDate.setMonth(expiryDate.getMonth() + 12);
const daysUntilExpiry = daysBetween(new Date(), expiryDate);
let auditStatus = 'expired';
if (daysUntilExpiry > 30) auditStatus = 'valid';
else if (daysUntilExpiry > 0) auditStatus = 'warning';

const entry = {
type: audit.auditType,
title: AUDIT_TYPES[audit.auditType]?.title || 'Unbekannt',
short: AUDIT_TYPES[audit.auditType]?.short || '??',
date: auditDate,
expiry: expiryDate,
status: auditStatus,
daysUntilExpiry,
instanceId: audit.meta?.instanceId,
hasDeviations: hasAuditDeviations(audit)
};

employee.audits = employee.audits || [];
const idx = employee.audits.findIndex(a => a.instanceId === entry.instanceId);

if (idx >= 0) {
const existing = employee.audits[idx];
if (!existing.date || auditDate > existing.date) {
employee.audits[idx] = entry;
}
} else {
employee.audits.push(entry);
}
}

function hasAuditDeviations(audit) {
if (!audit.questions || !Array.isArray(audit.questions)) return false;
return audit.questions.some(q => q.verdict === 'not-ok');
}

function updateEmployeeStatusFromAudits(employee) {
if (employee.audits && employee.audits.length > 0) {
employee.audits.sort((a, b) => b.date - a.date);
employee.latestAudit = employee.audits[0];
const expiries = employee.audits.map(a => a.expiry).filter(Boolean);
employee.nextAudit = expiries.length ? new Date(Math.min(...expiries.map(d => d.getTime()))) : null;

const hasExpired = employee.audits.some(a => a.status === 'expired');
const hasWarning = employee.audits.some(a => a.status === 'warning');
const allValid = employee.audits.every(a => a.status === 'valid');

if (hasExpired) employee.status = 'expired';
else if (hasWarning) employee.status = 'warning';
else if (allValid) employee.status = 'valid';
else employee.status = 'missing';
} else {
employee.status = 'missing';
}
}

function updateEmployeeStatus() {
const total = employees.length;
const valid = employees.filter(e => e.status === 'valid').length;
const el = document.getElementById('employeeStatus');
if (el) el.textContent = `${valid}/${total}`;
}

function updateStatistics(filteredEmployees) {
const total = filteredEmployees.length;
const valid = filteredEmployees.filter(e => e.status === 'valid').length;
const expired = filteredEmployees.filter(e => e.status === 'expired').length;
const warning = filteredEmployees.filter(e => e.status === 'warning').length;
const missing = filteredEmployees.filter(e => e.status === 'missing').length;
document.getElementById('statTotal').textContent = total;
document.getElementById('statValid').textContent = valid;
document.getElementById('statExpired').textContent = expired;
document.getElementById('statWarning').textContent = warning;
document.getElementById('statMissing').textContent = missing;
}

// === AUDIT-DATEIEN LADEN/SPEICHERN ===
async function loadAuditFiles() {
employeeAudits = [];
Object.keys(AUDIT_TYPES).forEach(auditType => {
const listKey = STORAGE_LIST_KEY(auditType);
const savedList = localStorage.getItem(listKey);
if (savedList) {
try {
const arr = JSON.parse(savedList);
if (Array.isArray(arr)) {
arr.forEach(auditData => {
const totalQuestions = auditData.questions?.length || 0;
const answeredQuestions = auditData.questions?.filter(q => q.verdict !== null).length || 0;
if (auditData.headerData?.operatorName?.trim() && totalQuestions > 0 && answeredQuestions === totalQuestions) {
employeeAudits.push({
...auditData,
auditType: auditType,
info: AUDIT_TYPES[auditType],
isComplete: true
});
}
});
}
} catch (e) {
console.error('Fehler beim Parsen von Auditliste:', e);
}
} else {
const oldKey = `zfpAudit_${auditType}`;
const saved = localStorage.getItem(oldKey);
if (saved) {
try {
const auditData = JSON.parse(saved);
const totalQuestions = auditData.questions?.length || 0;
const answeredQuestions = auditData.questions?.filter(q => q.verdict !== null).length || 0;
if (auditData.headerData?.operatorName?.trim() && totalQuestions > 0 && answeredQuestions === totalQuestions) {
employeeAudits.push({
...auditData,
auditType: auditType,
info: AUDIT_TYPES[auditType],
isComplete: true
});
localStorage.setItem(listKey, JSON.stringify([auditData]));
localStorage.removeItem(oldKey);
}
} catch (e) {
console.error('Fehler beim Parsen von altem Audit:', e);
}
}
}
});
await updateEmployeeAudits();
updateEmployeeStatus();
updateProcedureProgress();
}

async function updateEmployeeAudits() {
employees.forEach(employee => {
employee.audits = [];
employee.latestAudit = null;
employee.nextAudit = null;
employee.status = 'missing';

const empNum = employee.number?.trim().toLowerCase() || '';
const empName = employee.name?.toLowerCase() || '';

const latestByType = new Map();

employeeAudits.forEach(audit => {
const auditOperatorName = audit.headerData?.operatorName?.toLowerCase() || '';
const auditOperatorNumber = audit.headerData?.operatorNumber?.trim().toLowerCase() || '';

const matches =
(auditOperatorNumber && empNum && auditOperatorNumber === empNum) ||
(auditOperatorName && empName && auditOperatorName === empName);

if (matches) {
const existing = latestByType.get(audit.auditType);
const auditDate = audit.meta?.created ? new Date(audit.meta.created) : new Date();
if (!existing || auditDate > (existing.meta?.created ? new Date(existing.meta.created) : new Date(0))) {
latestByType.set(audit.auditType, audit);
}
}
});

latestByType.forEach(audit => addAuditToEmployee(employee, audit));
updateEmployeeStatusFromAudits(employee);
});
renderEmployeeList();
}

function updateProcedureProgress() {
Object.keys(AUDIT_TYPES).forEach(type => {
const auditsForType = employeeAudits.filter(a => a.auditType === type);
const total = auditsForType.length;
const complete = auditsForType.filter(a => a.isComplete).length;
const percent = total ? Math.round((complete / total) * 100) : 0;
const el = document.getElementById(`${type}Progress`);
if (el) el.textContent = `${percent}%`;
});
}

// === MITARBEITERLISTE RENDERING ===
function renderEmployeeList() {
const tbody = document.getElementById('employeeTableBody');
tbody.innerHTML = '';
let filteredEmployees = employees;

if (employeeSearchFilter) {
const searchLower = employeeSearchFilter.toLowerCase();
filteredEmployees = filteredEmployees.filter(emp =>
(emp.name || '').toLowerCase().includes(searchLower) ||
(emp.number || '').toLowerCase().includes(searchLower) ||
(emp.certNumber || '').toLowerCase().includes(searchLower)
);
}
if (statusFilter !== 'all') {
filteredEmployees = filteredEmployees.filter(emp => emp.status === statusFilter);
}
if (glassesFilter !== 'all') {
filteredEmployees = filteredEmployees.filter(emp => emp.glasses === glassesFilter);
}

updateStatistics(filteredEmployees);

filteredEmployees.forEach(employee => {
const row = document.createElement('tr');
row.className = employee.status || 'missing';
const statusMap = {
valid: ['‚úÖ G√ºltig', 'status-valid'],
expired: ['‚ùå Abgelaufen', 'status-expired'],
warning: ['‚ö†Ô∏è L√§uft ab', 'status-warning'],
missing: ['‚≠ï Kein Audit', 'status-missing']
};
const [statusText, statusClass] = statusMap[employee.status] || statusMap['missing'];
let glassesIcon = '‚ùì';
if (employee.glasses === 'yes') glassesIcon = 'üëì';
else if (employee.glasses === 'no') glassesIcon = '‚ùå';

const lastAuditText = employee.latestAudit ? formatGermanDate(employee.latestAudit.date) : '‚Äì';
const nextAuditText = employee.nextAudit ? formatGermanDate(employee.nextAudit) : '‚Äì';

let proceduresHTML = '<div class="audit-procedures">';
const seen = new Set();
if (employee.audits && employee.audits.length > 0) {
employee.audits.forEach(audit => {
if (seen.has(audit.type)) return;
seen.add(audit.type);
const procedureClass = `procedure-badge procedure-${audit.status}`;
proceduresHTML += `<span class="${procedureClass}">${audit.short}</span>`;
});
} else {
proceduresHTML += '<span style="color: #999; font-style: italic;">Keine Audits</span>';
}
proceduresHTML += '</div>';

row.innerHTML = `
<td><span class="status-badge ${statusClass}">${statusText}</span></td>
<td><strong>${employee.name || ''}</strong>${employee.department ? `<br><small>${employee.department}</small>` : ''}</td>
<td>${employee.number || ''}</td>
<td class="glasses-icon">${glassesIcon}</td>
<td>${employee.certNumber || ''}</td>
<td>${employee.eyeTestDate || ''}</td>
<td>${lastAuditText}</td>
<td>${nextAuditText}</td>
<td>${proceduresHTML}</td>
<td>
<div class="employee-actions" style="display: flex; gap: 5px; flex-wrap: wrap;">
<button class="employee-action-btn edit" data-id="${employee.id}" style="padding: 4px 8px; background: #3498db; color: white; border: none; border-radius: 3px; cursor: pointer; font-size: 0.8em; white-space: nowrap;">‚úèÔ∏è</button>
<button class="employee-action-btn audits" data-id="${employee.id}" style="padding: 4px 8px; background: #9b59b6; color: white; border: none; border-radius: 3px; cursor: pointer; font-size: 0.8em; white-space: nowrap;">üìä</button>
<button class="employee-action-btn authorization" data-id="${employee.id}" style="padding: 4px 8px; background: #2ecc71; color: white; border: none; border-radius: 3px; cursor: pointer; font-size: 0.8em; white-space: nowrap;">üìã</button>
<button class="employee-action-btn delete" data-id="${employee.id}" style="padding: 4px 8px; background: #e74c3c; color: white; border: none; border-radius: 3px; cursor: pointer; font-size: 0.8em; white-space: nowrap;">üóëÔ∏è</button>
</div>
</td>
`;
tbody.appendChild(row);
});

tbody.querySelectorAll('.employee-action-btn.edit').forEach(btn => {
btn.onclick = (e) => {
const id = e.currentTarget.dataset.id;
if (id) editEmployee(id);
};
});

tbody.querySelectorAll('.employee-action-btn.audits').forEach(btn => {
btn.onclick = (e) => {
const id = e.currentTarget.dataset.id;
if (id) showAuditListForEmployee(id);
};
});

tbody.querySelectorAll('.employee-action-btn.authorization').forEach(btn => {
btn.onclick = (e) => {
const id = e.currentTarget.dataset.id;
if (id) createAuthorizationFromEmployee(id);
};
});

tbody.querySelectorAll('.employee-action-btn.delete').forEach(btn => {
btn.onclick = async (e) => {
const id = e.currentTarget.dataset.id;
if (!id) return;
const shouldDelete = await showCustomModal('Mitarbeiter wirklich l√∂schen?');
if (shouldDelete) deleteEmployee(id);
};
});
}

// === AUTORISIERUNG AUS MITARBEITERDATEN ERSTELLEN ===
function createAuthorizationFromEmployee(employeeId) {
const employee = employees.find(e => e.id === employeeId);
if (!employee) {
showInfoModal('‚ùå Mitarbeiter nicht gefunden!');
return;
}

const validAudits = [];
const empNum = employee.number?.trim().toLowerCase() || '';
const empName = employee.name?.toLowerCase() || '';

employeeAudits.forEach(audit => {
const auditOperatorName = audit.headerData?.operatorName?.toLowerCase() || '';
const auditOperatorNumber = audit.headerData?.operatorNumber?.trim().toLowerCase() || '';

const matches =
(auditOperatorNumber && empNum && auditOperatorNumber === empNum) ||
(auditOperatorName && empName && auditOperatorName === empName);

if (matches) {
const questions = audit.questions || [];
const total = questions.length;
const answered = questions.filter(q => q.verdict !== null).length;
const notOk = questions.filter(q => q.verdict === 'not-ok').length;
const activityProofQuestion = questions.find(q => q.isActivityProof);
const activityProofOk = activityProofQuestion && activityProofQuestion.verdict === 'ok';

if (answered === total && notOk === 0 && activityProofOk) {
validAudits.push(audit);
}
}
});

if (validAudits.length === 0) {
showInfoModal('‚ùå Keine g√ºltigen Audits f√ºr diesen Mitarbeiter gefunden!\n\nEin Audit muss:\n1. Vollst√§ndig beantwortet sein\n2. Keine "Nicht OK" Bewertungen haben\n3. Einen bestandenen T√§tigkeitsnachweis enthalten');
return;
}

const latestAudit = validAudits.sort((a, b) => {
const dateA = a.meta?.created ? new Date(a.meta.created) : new Date(0);
const dateB = b.meta?.created ? new Date(b.meta.created) : new Date(0);
return dateB - dateA;
})[0];

const tempHeaderData = {
operatorName: employee.name || '',
operatorNumber: employee.number || '',
operatorDept: employee.department || '',
operatorCert: employee.certificate || '',
auditorName: latestAudit.headerData?.auditorName || '',
auditorDept: latestAudit.headerData?.auditorDept || '',
auditorCert: latestAudit.headerData?.auditorCert || '',
auditorPhone: latestAudit.headerData?.auditorPhone || '',
approverName: latestAudit.headerData?.approverName || '',
approverDept: latestAudit.headerData?.approverDept || '',
approverCert: latestAudit.headerData?.approverCert || '',
approverPhone: latestAudit.headerData?.approverPhone || '',
reportNumber: latestAudit.headerData?.reportNumber || `AUTO-${employee.number || 'EMP'}-${new Date().toISOString().slice(0,10)}`,
partType: latestAudit.headerData?.partType || '',
externalStandard: latestAudit.headerData?.externalStandard || '',
sStandard: latestAudit.headerData?.sStandard || '',
workInstruction: latestAudit.headerData?.workInstruction || ''
};

const authorizedProcedures = [];
validAudits.forEach(audit => {
if (!authorizedProcedures.some(p => p.type === audit.auditType)) {
authorizedProcedures.push({
type: audit.auditType,
title: AUDIT_TYPES[audit.auditType]?.title || audit.auditType,
short: AUDIT_TYPES[audit.auditType]?.short || audit.auditType.slice(0,2).toUpperCase(),
auditDate: audit.meta?.created ? new Date(audit.meta.created) : new Date()
});
}
});

showAuthorizationFromEmployeeData(employee, tempHeaderData, authorizedProcedures);
}

function showAuthorizationFromEmployeeData(employee, headerData, authorizedProcedures) {
  if (authorizedProcedures.length === 0) {
    showInfoModal('‚ùå Keine autorisierbaren Verfahren gefunden!');
    return;
  }

  const uniqueCerts = employee.certificate ? employee.certificate.split(',').map(c => c.trim()).filter(c => c) : [];
  
  let werk = '';
  let werkText = '';
  let isNdtSupervisor = false;
  
  // Pr√ºfen ob der Mitarbeiter NDT Supervisor ist (basierend auf Notizen)
  if (employee.notes && employee.notes.toLowerCase().includes('ndt supervisor')) {
    isNdtSupervisor = true;
  }
  
  if (employee.department) {
    if (employee.department.includes('SW1') || employee.department.includes('WI/SW1')) {
      werk = 'Werk 1';
      if (isNdtSupervisor) {
        werkText = 'Die genannte Person ist NDT Supervisor in Schweinfurt und berechtigt zur Durchf√ºhrung der Pr√ºfverfahren sowie zur Autorisierung von Pr√ºfern der Stufen 1 und 2.';
      } else {
        werkText = 'Die genannte Person ist befugt die folgenden Zerst√∂rungsfreien Pr√ºfverfahren im Werk 1 durchzuf√ºhren!';
      }
    } else if (employee.department.includes('SW2') || employee.department.includes('WI/SW2')) {
      werk = 'Werk 2';
      if (isNdtSupervisor) {
        werkText = 'Die genannte Person ist NDT Supervisor in Schweinfurt und berechtigt zur Durchf√ºhrung der Pr√ºfverfahren sowie zur Autorisierung von Pr√ºfern der Stufen 1 und 2.';
      } else {
        werkText = 'Die genannte Person ist befugt die folgenden Zerst√∂rungsfreien Pr√ºfverfahren im Werk 2 durchzuf√ºhren!';
      }
    }
  }
  
  // Fallback wenn kein Werk erkannt wurde
  if (!werkText) {
    if (isNdtSupervisor) {
      werkText = 'Die genannte Person ist NDT Supervisor in Schweinfurt und berechtigt zur Durchf√ºhrung der Pr√ºfverfahren sowie zur Autorisierung von Pr√ºfern der Stufen 1 und 2.';
    } else {
      werkText = 'Die genannte Person ist befugt die folgenden Zerst√∂rungsfreien Pr√ºfverfahren durchzuf√ºhren!';
    }
  }

  const latestAuditDate = authorizedProcedures.reduce((latest, proc) => {
    return proc.auditDate > latest ? proc.auditDate : latest;
  }, authorizedProcedures[0].auditDate);

  const authorizationDate = new Date();
  const expiryDate = new Date(latestAuditDate);
  expiryDate.setMonth(expiryDate.getMonth() + 12);

  const formatDate = (date) => {
    if (!date) return '';
    const d = new Date(date);
    const day = d.getDate().toString().padStart(2, '0');
    const month = (d.getMonth() + 1).toString().padStart(2, '0');
    const year = d.getFullYear();
    return `${day}.${month}.${year}`;
  };

  const authDateFormatted = formatDate(authorizationDate);
  const expiryDateFormatted = formatDate(expiryDate);
  const birthdateFormatted = employee.birthdate ? formatDate(parseGermanDate(employee.birthdate)) : '';
  const eyeTestFormatted = employee.eyeTestDate ? formatDate(parseGermanDate(employee.eyeTestDate)) : '';

  const authorizationText = `<strong>Die genannte Person hat nachweislich die in der Verfahrensanweisung
INFSW17008 beschriebenen Voraussetzungen f√ºr Ausbildung, Schulung
Berufserfahrung, fortlaufende T√§tigkeit und Pr√ºfung erf√ºllt und ist damit f√ºr die
Durchf√ºhrung der Pr√ºfung in den oben gelisteten ZfP-Verfahren autorisiert. Die Autorisierung gilt nur in Verbindung mit einem g√ºltigen Zertifikat und hat
eine G√ºltigkeit von 12 Monaten.</strong><br><br><em>The named person has demonstrably fulfilled the requirements for training, education, professional experience, ongoing activity, and examination described in the procedure instruction INFSW17008 and is therefore authorized to conduct the examination in the NDT procedures listed below. This authorization is valid only in conjunction with a valid certificate and is valid for 12 months.</em>`;

  // OPTIMIERTE VERSION MIT MITARBEITERINFORMATIONEN IN ZWEI SPALTEN
  let authorizationHTML = `
<div style="width: 210mm; margin: 0 auto; padding: 3mm 5mm; font-family: Arial, sans-serif; font-size: 10pt; line-height: 1.3; color: #000 !important; min-height: 297mm; box-sizing: border-box;">
  <!-- HEADER MIT GR√ñSSEREM LOGO -->
  <div style="position: relative; border-bottom: 2px solid #000; padding-bottom: 6px; margin-bottom: 10px; text-align: center;">
    <div style="position: absolute; top: 0; right: 0; text-align: right;">
      <img src="https://upload.wikimedia.org/wikipedia/commons/7/72/Schaeffler_logo.svg"
        alt="Schaeffler Logo"
        style="height: 7.5mm; width: auto; max-width: 40mm;">
    </div>
    <h1 style="font-size: 16pt; margin: 0 0 3px 0; color: #000 !important; line-height: 1.1;">AUTORISIERUNG</h1>
    <div style="font-size: 10pt; color: #000 !important; font-weight: bold; margin-bottom: 2px;">
      f√ºr zerst√∂rungsfreie Pr√ºfung
    </div>
    <div class="english-subtitle" style="font-size: 9pt; color: #000 !important; font-style: italic; font-weight: normal;">
      for non-destructive testing
    </div>
  </div>

  <!-- PERSONAL DATA - IN ZWEI SPALTEN -->
  <div style="margin-bottom: 12px; border: 1px solid #ccc; background: #f9f9f9; border-radius: 3px; width: 190mm; margin-left: auto; margin-right: auto;">
    <!-- BEREICHS√úBERSCHRIFT MIT UNTERSTRICH -->
    <div style="padding: 10px 12px; border-bottom: 1px solid #ddd; background: #f0f0f0;">
      <div class="header-section-title" style="font-size: 10pt; color: #000 !important; text-align: center;">
        <div style="font-weight: bold;">Mitarbeiterinformationen</div>
        <div class="english" style="font-style: italic; font-weight: normal; color: #666 !important;">Employee Information</div>
      </div>
    </div>
    
    <!-- ZWEI-SPALTEN-LAYOUT F√úR MITARBEITERINFORMATIONEN -->
    <div style="padding: 12px; font-size: 9.5pt;">
      <div style="display: flex; gap: 20px;">
        <!-- LINKE SPALTE -->
        <div style="flex: 1; display: flex; flex-direction: column; gap: 6px;">
          <div><strong>Name:</strong> ${employee.name || '---'}</div>
          
          <div><strong>Personalnummer:</strong> ${employee.number || '---'}</div>
          
          ${employee.department ? `<div><strong>Abteilung:</strong> ${employee.department}</div>` : ''}
          
          ${employee.birthdate ? `<div><strong>Geburtsdatum:</strong> ${birthdateFormatted}</div>` : ''}
        </div>
        
        <!-- RECHTE SPALTE -->
        <div style="flex: 1; display: flex; flex-direction: column; gap: 6px;">
          ${employee.certNumber ? `<div><strong>Identifikationsnummer:</strong> ${employee.certNumber}</div>` : ''}
          
          ${uniqueCerts.length > 0 ? `<div><strong>Zertifikate:</strong> ${uniqueCerts.join(', ')}</div>` : ''}
          
          ${employee.eyeTestDate ? `<div><strong>Letzter Sehtest:</strong> ${eyeTestFormatted}</div>` : ''}
          
          ${employee.glasses && employee.glasses !== 'unknown' ? `
            <div><strong>Brillenbedarf:</strong> ${employee.glasses === 'yes' ? 'Ja / Yes' : employee.glasses === 'no' ? 'Nein / No' : 'Unbekannt / Unknown'}</div>
          ` : ''}
        </div>
      </div>
      
      ${employee.notes ? `
      <div style="margin-top: 12px; padding-top: 12px; border-top: 1px solid #ddd;">
        <strong>Notizen:</strong> ${employee.notes}
      </div>
      ` : ''}
    </div>
  </div>

  <!-- AUTHORIZATION TEXT - ANGEPASST AN ANDERE K√ÑSTEN -->
  <div style="margin: 12px auto; border: 1px solid #ccc; background: #f9f9f9; border-radius: 3px; width: 190mm;">
    <!-- BEREICHS√úBERSCHRIFT MIT UNTERSTRICH -->
    <div style="padding: 10px 12px; border-bottom: 1px solid #ddd; background: #f0f0f0;">
      <div class="header-section-title" style="font-size: 10pt; color: #000 !important; text-align: center;">
        <div style="font-weight: bold;">Autorisierungsgrundlage</div>
        <div class="english" style="font-style: italic; font-weight: normal; color: #666 !important;">Authorization Basis</div>
      </div>
    </div>
    
    <!-- HAUPTTEXT -->
    <div style="padding: 12px; font-size: 9.5pt; line-height: 1.35;">
      ${authorizationText}
    </div>
  </div>

  <!-- BEFUGNISSE KASTEN - ANGEPASST AN ANDERE K√ÑSTEN -->
  <div style="margin: 15px auto; width: 190mm;">
    <div style="border: 1px solid #ccc; background: #fff; border-radius: 3px;">
      <!-- BEREICHS√úBERSCHRIFT MIT UNTERSTRICH -->
      <div style="padding: 10px 12px; border-bottom: 1px solid #ddd; background: #f0f0f0;">
        <div class="header-section-title" style="font-size: 10pt; color: #000 !important; text-align: center;">
          <div style="font-weight: bold;">Befugnisse</div>
          <div class="english" style="font-style: italic; font-weight: normal; color: #666 !important;">Authorizations</div>
        </div>
      </div>
      
      <!-- INHALT -->
      <div style="padding: 12px;">
        <div style="font-weight: bold; font-size: 10pt; margin-bottom: ${isNdtSupervisor ? '4px' : '8px'}; color: #000 !important; text-align: left;">
          ${werkText}
        </div>
        ${isNdtSupervisor ? `
        <div style="font-size: 8.5pt; color: #666 !important; margin-bottom: 8px; text-align: left; font-style: italic; line-height: 1.2;">
          <i>The named individual is NDT Supervisor in Schweinfurt, authorized to perform the inspection methods and to authorize Level 1 and 2 inspectors.</i>
        </div>
        ` : `
        <div style="font-size: 9pt; color: #666 !important; margin-bottom: 10px; text-align: left; font-style: italic;">
          <i>The above-mentioned employee is authorized to perform the following non-destructive testing procedures ${werk ? 'in ' + werk : ''}!</i>
        </div>
        `}
        <div style="max-height: 60mm; overflow-y: auto; padding: 0 5px; display: grid; grid-template-columns: repeat(auto-fill, minmax(85mm, 1fr)); gap: 5px;">
          ${authorizedProcedures.map(proc =>
            `<div style="padding: 6px 8px; margin-bottom: 4px; background: #f0f0f0; border-radius: 2px; font-size: 9pt; border-left: 3px solid #3498db; text-align: center;">
              ‚Ä¢ ${proc.title} (${proc.short})
            </div>`
          ).join('')}
        </div>
      </div>
    </div>
  </div>

  <!-- UNTERSCHRIFTEN MIT SPEZIELLER LOGIK F√úR NDT SUPERVISOR -->
  ${isNdtSupervisor ? `
  <!-- UNTERSCHRIFTEN F√úR NDT SUPERVISOR (Q-MANAGER & NDT SUPERVISOR) -->
  <div style="margin-top: 20px; padding-top: 15px; border-top: 2px solid #000; display: flex; justify-content: space-between; gap: 25px; min-height: 35mm; width: 190mm; margin-left: auto; margin-right: auto;">
    <div style="flex: 1; text-align: center;">
      <div style="font-weight: bold; font-size: 9.5pt; margin-bottom: 4px; color: #000 !important;">
        Q-Manager
      </div>
      <div style="font-size: 8.5pt; color: #666 !important; margin-bottom: 8px;">
        <i>Quality Manager</i>
      </div>
      <div style="margin-top: 15mm; min-height: 10mm; padding-top: 8px;">
        __________________________
      </div>
      <div style="font-size: 8pt; color: #888 !important; margin-top: 3px;">
        (Name, Datum, Unterschrift)
      </div>
    </div>

    <div style="flex: 1; text-align: center;">
      <div style="font-weight: bold; font-size: 9.5pt; margin-bottom: 4px; color: #000 !important;">
        NDT Supervisor
      </div>
      <div style="font-size: 8.5pt; color: #666 !important; margin-bottom: 8px;">
        <i>NDT Supervisor</i>
      </div>
      <div style="margin-top: 15mm; min-height: 10mm; padding-top: 8px;">
        __________________________
      </div>
      <div style="font-size: 8pt; color: #888 !important; margin-top: 3px;">
        (Name, Datum, Unterschrift)
      </div>
    </div>
  </div>
  ` : `
  <!-- UNTERSCHRIFTEN F√úR NORMALE MITARBEITER -->
  <div style="margin-top: 20px; padding-top: 15px; border-top: 2px solid #000; display: flex; justify-content: space-between; gap: 25px; min-height: 35mm; width: 190mm; margin-left: auto; margin-right: auto;">
    <div style="flex: 1; text-align: center;">
      <div style="font-weight: bold; font-size: 9.5pt; margin-bottom: 4px; color: #000 !important;">
        Autorisierter Mitarbeiter
      </div>
      <div style="font-size: 8.5pt; color: #666 !important; margin-bottom: 8px;">
        <i>Authorized Employee</i>
      </div>
      <div style="margin-top: 15mm; min-height: 10mm; padding-top: 8px;">
        __________________________
      </div>
      <div style="font-size: 8pt; color: #888 !important; margin-top: 3px;">
        (Name, Datum, Unterschrift)
      </div>
    </div>

    <div style="flex: 1; text-align: center;">
      <div style="font-weight: bold; font-size: 9.5pt; margin-bottom: 4px; color: #000 !important;">
        NDT Supervisor
      </div>
      <div style="font-size: 8.5pt; color: #666 !important; margin-bottom: 8px;">
        <i>NDT Supervisor</i>
      </div>
      <div style="margin-top: 15mm; min-height: 10mm; padding-top: 8px;">
        __________________________
      </div>
      <div style="font-size: 8pt; color: #888 !important; margin-top: 3px;">
        (Name, Datum, Unterschrift)
      </div>
    </div>
  </div>
  `}
<div style="text-align: center; margin: 12px auto; width: 160mm;">
  <div style="display: inline-block; width: 100mm; border: 2px solid #2c3e50; border-radius: 6px; padding: 8px 12px; font-family: Arial, sans-serif; font-size: 9pt; color: #2c3e50; background: white; line-height: 1.2;">

    <!-- Titel -->
    <div style="font-weight: bold; text-align: center; margin-bottom: 6px; font-size: 10pt;">
      AUTORISIERUNG ERTEILT
    </div>

    <!-- Datumszeile - PERFEKT SYMMETRISCH -->
    <div style="display: flex; justify-content: center; align-items: center; margin-bottom: 4px; gap: 40px;">
      
      <!-- Linkes Datum - zentriert in seiner H√§lfte -->
      <div style="width: 40mm; text-align: center;">
        <div style="font-size: 8pt; color: #555; line-height: 1.1;">Autorisierungsdatum</div>
        <div style="font-weight: bold; font-size: 9pt; line-height: 1.2; margin-top: 2px;">${authDateFormatted}</div>
      </div>
      
      <!-- Rechtes Datum - zentriert in seiner H√§lfte -->
      <div style="width: 40mm; text-align: center;">
        <div style="font-size: 8pt; color: #555; line-height: 1.1;">G√ºltig bis</div>
        <div style="font-weight: bold; font-size: 9pt; line-height: 1.2; margin-top: 2px;">${expiryDateFormatted}</div>
      </div>
      
    </div>

    <!-- G√ºltigkeitsdauer -->
    <div style="margin-top: 6px; padding: 4px 6px; background: #f4f6f8; border-radius: 3px; font-size: 9pt; text-align: center; line-height: 1.2;">
      G√ºltigkeitsdauer: <strong>12 Monate</strong>
    </div>

    <!-- Hinweis -->
    <div style="margin-top: 5px; font-size: 8pt; color: #666; text-align: center; line-height: 1.1;">
      G√ºltig nur in Verbindung mit einem g√ºltigen Zertifikat
    </div>

  </div>
</div>

  <!-- FOOTER GANZ UNTEN -->
  <div style="position: absolute; bottom: 3mm; left: 5mm; right: 5mm; padding-top: 8px; border-top: 1px solid #ccc; font-size: 8pt; color: #444 !important;">
    <table style="width: 100%; border-collapse: collapse;">
      <tr>
        <td style="text-align: left; width: 33%;">Daniel H√§usner, WI/SW2-PQT</td>
        <td style="text-align: center; width: 34%;">Operator Audit Tool - Schaeffler Technologies</td>
        <td style="text-align: right; width: 33%;">Version AB, 29.01.2026</td>
      </tr>
    </table>
  </div>
</div>
`;

  document.getElementById('authorizationContainer').innerHTML = `
<div class="report-action-buttons">
  <button class="report-action-btn print-btn" onclick="printFullAuthorization()">üñ®Ô∏è</button>
  <button class="report-action-btn close-btn" onclick="closeAuthorization()">‚úï</button>
</div>
${authorizationHTML}
`;
  document.getElementById('authorizationOverlay').style.display = 'block';
  document.body.style.overflow = 'hidden';
}

async function showAuditListForEmployee(employeeId) {
const employee = employees.find(e => e.id === employeeId);
if (!employee) return;

currentAuditListEmployeeId = employeeId;

const employeeAuditsList = [];
const empNum = employee.number?.trim().toLowerCase() || '';
const empName = employee.name?.toLowerCase() || '';

employeeAudits.forEach(audit => {
const auditOperatorName = audit.headerData?.operatorName?.toLowerCase() || '';
const auditOperatorNumber = audit.headerData?.operatorNumber?.trim().toLowerCase() || '';

const matches =
(auditOperatorNumber && empNum && auditOperatorNumber === empNum) ||
(auditOperatorName && empName && auditOperatorName === empName);

if (matches) {
employeeAuditsList.push(audit);
}
});

employeeAuditsList.sort((a, b) => {
const dateA = a.meta?.created ? new Date(a.meta.created) : new Date(0);
const dateB = b.meta?.created ? new Date(b.meta.created) : new Date(0);
return dateB - dateA;
});

renderAuditListModal(employee, employeeAuditsList);
}

function renderAuditListModal(employee, audits) {
const container = document.getElementById('auditListContainer');
const title = document.getElementById('auditListTitle');

title.textContent = `Audits f√ºr ${employee.name}`;

if (audits.length === 0) {
container.innerHTML = '<div class="no-audits-message">Keine Audits f√ºr diesen Mitarbeiter gefunden.</div>';
} else {
let html = '';

audits.forEach((audit, index) => {
const auditDate = audit.meta?.created ? new Date(audit.meta.created) : new Date();
const formattedDate = formatGermanDate(auditDate);
const totalQuestions = audit.questions?.length || 0;
const answeredQuestions = audit.questions?.filter(q => q.verdict !== null).length || 0;
const okQuestions = audit.questions?.filter(q => q.verdict === 'ok').length || 0;
const notOkQuestions = audit.questions?.filter(q => q.verdict === 'not-ok').length || 0;
const hasDeviations = notOkQuestions > 0;
const isReviewed = isAuditReviewed(audit.meta?.instanceId);
const reviewStatus = isReviewed ? 'reviewed' : '';
const isComplete = answeredQuestions === totalQuestions;

html += `
<div class="audit-item ${hasDeviations && !isReviewed ? 'has-deviations' : ''}">
<div class="audit-item-header">
<div class="audit-item-title">${audit.info.title} (${audit.info.short})</div>
<div class="audit-item-date">${formattedDate}</div>
</div>
<div class="audit-item-details">
<div>Pr√ºfbericht: ${audit.headerData?.reportNumber || '---'}</div>
<div>Ergebnis: ${okQuestions}/${totalQuestions} OK, ${notOkQuestions} Nicht OK</div>
<div>Status: ${isComplete ? '‚úÖ Vollst√§ndig' : '‚ö†Ô∏è Unvollst√§ndig'}</div>
${hasDeviations ? `<div class="audit-item-deviations">‚ö†Ô∏è ${notOkQuestions} Abweichung(en) vorhanden</div>` : ''}
</div>
<div class="audit-item-actions">
<button class="mark-reviewed-btn ${reviewStatus}" data-audit-id="${audit.meta?.instanceId}">
${isReviewed ? '‚úÖ Gepr√ºft' : 'üìù Als gepr√ºft markieren'}
</button>
<button class="load-audit-btn" data-audit-index="${index}" style="padding: 4px 8px; background: #3498db; color: white; border: none; border-radius: 3px; cursor: pointer; font-size: 0.8em;">
üìÇ Audit laden
</button>
</div>
</div>
`;
});

container.innerHTML = html;

// Event Listener f√ºr Lade-Buttons
container.querySelectorAll('.load-audit-btn').forEach(btn => {
btn.onclick = (e) => {
const auditIndex = parseInt(e.currentTarget.dataset.auditIndex);
const audit = audits[auditIndex];
if (audit) {
loadAuditFromList(audit);
document.getElementById('auditListModal').style.display = 'none';
}
};
});

// Event Listener f√ºr Review-Buttons
container.querySelectorAll('.mark-reviewed-btn').forEach(btn => {
btn.onclick = async (e) => {
const auditId = e.currentTarget.dataset.auditId;
if (isAuditReviewed(auditId)) {
await unmarkAuditAsReviewed(auditId);
e.currentTarget.textContent = 'üìù Als gepr√ºft markieren';
e.currentTarget.classList.remove('reviewed');

const auditItem = e.currentTarget.closest('.audit-item');
if (auditItem.classList.contains('has-deviations')) {
const auditIndex = Array.from(auditItem.parentNode.children).indexOf(auditItem);
const audit = audits[auditIndex];
if (audit && hasAuditDeviations(audit)) {
auditItem.classList.add('has-deviations');
} else {
auditItem.classList.remove('has-deviations');
}
}
} else {
await markAuditAsReviewed(auditId);
e.currentTarget.textContent = '‚úÖ Gepr√ºft';
e.currentTarget.classList.add('reviewed');
e.currentTarget.closest('.audit-item').classList.remove('has-deviations');
}
};
});
}

document.getElementById('auditListModal').style.display = 'flex';
}

function ensureEmployeeFromHeader(headerData) {
if (!headerData) return null;
const name = (headerData.operatorName || '').trim();
const number = (headerData.operatorNumber || '').trim();
if (!name && !number) return null;

let emp = null;
if (number) {
emp = employees.find(e => (e.number || '').trim().toLowerCase() === number.toLowerCase());
}
if (!emp && name) {
emp = employees.find(e => (e.name || '').trim().toLowerCase() === name.toLowerCase());
}

if (emp) {
let changed = false;
const dept = headerData.operatorDept || '';
const cert = headerData.operatorCert || '';
if (dept && !emp.department) { emp.department = dept; changed = true; }
if (cert && !emp.certificate) { emp.certificate = cert; changed = true; }
if (changed) saveEmployees();
return emp;
}

const newEmp = {
id: Date.now().toString() + Math.random().toString(36).slice(2,7),
name: name || '(Ohne Name)',
number: number || '',
birthdate: '',
eyeTestDate: '',
certNumber: '',
glasses: 'unknown',
department: headerData.operatorDept || '',
certificate: headerData.operatorCert || '',
notes: '',
created: new Date().toISOString(),
updated: new Date().toISOString(),
audits: [],
authorizations: [],
status: 'missing'
};
employees.push(newEmp);
saveEmployees();
updateEmployeeAudits();
renderEmployeeList();
return newEmp;
}

async function upsertAuditInList(auditData) {
try {
if (!auditData || !auditData.meta || !auditData.meta.auditType) return;
if (!auditData.meta.instanceId) {
auditData.meta.instanceId = 'AUD-' + Date.now() + '-' + Math.random().toString(36).slice(2,8);
}
const type = auditData.meta.auditType;
const key = STORAGE_LIST_KEY(type);
let list = [];
const raw = localStorage.getItem(key);
if (raw) { try { list = JSON.parse(raw) || []; } catch (e) { list = []; } }

const idx = list.findIndex(a => a?.meta?.instanceId === auditData.meta.instanceId);
if (idx >= 0) list[idx] = auditData;
else list.push(auditData);

localStorage.setItem(key, JSON.stringify(list));

// AUTOMATISCHE Cloud-Sync
if (cloudConnected && !cloudSyncInProgress) {
await syncSingleAuditToCloud(auditData);
}

loadAuditFiles();
renderEmployeeList();
} catch (e) {
console.error('upsertAuditInList error:', e);
}
}

function importEmployeeListData(e) {
const file = e.target.files[0];
if (!file) return;
const reader = new FileReader();
reader.onload = async function(evt) {
try {
const data = JSON.parse(evt.target.result);
let imported = [];
if (Array.isArray(data)) imported = data;
else if (data && Array.isArray(data.employees)) imported = data.employees;
else throw new Error('Unbekanntes Mitarbeiterlisten-Format');
if (!imported.length) throw new Error('Keine Mitarbeiter gefunden');

employees = imported.map(emp => ({
id: emp.id || (Date.now().toString() + Math.random().toString(36).slice(2,8)),
name: emp.name || '',
number: emp.number || '',
birthdate: emp.birthdate || '',
eyeTestDate: emp.eyeTestDate || '',
certNumber: emp.certNumber || '',
glasses: emp.glasses || 'unknown',
department: emp.department || '',
certificate: emp.certificate || '',
notes: emp.notes || '',
created: emp.created || new Date().toISOString(),
updated: new Date().toISOString(),
audits: emp.audits || [],
authorizations: emp.authorizations || [],
status: emp.status || 'missing'
}));
await saveEmployees();
loadAuditFiles();
renderEmployeeList();
showInfoModal(`‚úÖ ${employees.length} Mitarbeiter importiert!`);
} catch (err) {
showCustomModal(`‚ùå Import fehlgeschlagen: ${err.message}`);
} finally {
e.target.value = '';
}
};
reader.readAsText(file);
}

function cloneAuditForExport(auditData) {
const snapshot = JSON.parse(JSON.stringify(auditData));
snapshot.meta = {
...snapshot.meta,
instanceId: 'AUD-' + Date.now() + '-' + Math.random().toString(36).slice(2,8),
created: new Date().toISOString(),
lastModified: new Date().toISOString(),
sourceInstanceId: auditData.meta?.instanceId || null
};
return snapshot;
}

// === INITIALISIERUNG ===
document.addEventListener('DOMContentLoaded', async function() {
// Supabase initialisieren
await initSupabase();

// App initialisieren
initializeApp();
setupEventListeners();

// Cloud-Verbindung pr√ºfen und initial synchronisieren
setTimeout(async () => {
if (cloudConnected) {
await syncFromCloud(); // Initiale Synchronisation von Cloud
}
}, 2000);
});

function initializeApp() {
loadAllAuditData();
updateAuditProgressDisplays();

loadEmployees();
loadAuditReviews();
loadAuditFiles();
renderEmployeeList();
updateEmployeeStatus();

// Event Listener f√ºr Modals
document.getElementById('modalConfirmBtn').addEventListener('click', function() {
if (customModalResolve) customModalResolve(true);
closeCustomModal();
});

document.getElementById('modalCancelBtn').addEventListener('click', function() {
if (customModalResolve) customModalResolve(false);
closeCustomModal();
});

document.getElementById('employeeModalCancel').addEventListener('click', () => {
document.getElementById('employeeModal').style.display = 'none';
currentEmployeeEditId = null;
});

document.getElementById('employeeModalSave').addEventListener('click', async () => {
const name = document.getElementById('employeeName').value.trim();
const number = document.getElementById('employeeNumber').value.trim();
const birthdate = document.getElementById('employeeBirthdate').value.trim();
const eyeTestDate = document.getElementById('employeeEyeTest').value.trim();
const certNumber = document.getElementById('employeeCertNumber').value.trim();
const glasses = document.getElementById('employeeGlasses').value;
const department = document.getElementById('employeeDepartment').value.trim();
const certificate = document.getElementById('employeeCertificate').value.trim();
const notes = document.getElementById('employeeNotes').value.trim();
if (!name || !number) {
showInfoModal('Bitte Name und Personalnummer eingeben!');
return;
}

if (currentEmployeeEditId) {
const index = employees.findIndex(e => e.id === currentEmployeeEditId);
if (index !== -1) {
employees[index] = {
...employees[index],
name, number, glasses, department, certificate, notes,
birthdate,
eyeTestDate,
certNumber,
updated: new Date().toISOString()
};
}
} else {
const newEmployee = {
id: Date.now().toString(),
name, number, glasses, department, certificate, notes,
birthdate,
eyeTestDate,
certNumber,
created: new Date().toISOString(),
updated: new Date().toISOString(),
audits: [],
authorizations: [],
status: 'missing'
};
employees.push(newEmployee);
}
await saveEmployees();
updateEmployeeAudits();
renderEmployeeList();
document.getElementById('employeeModal').style.display = 'none';
currentEmployeeEditId = null;
showInfoModal('‚úÖ Mitarbeiter gespeichert!');
});

document.getElementById('auditListClose').addEventListener('click', () => {
document.getElementById('auditListModal').style.display = 'none';
currentAuditListEmployeeId = null;
});

document.getElementById('auditListLoadAll').addEventListener('click', async () => {
if (!cloudConnected) {
showInfoModal('‚ùå Keine Cloud-Verbindung');
return;
}

const success = await syncAllToCloud();
if (success) {
showInfoModal('‚úÖ Alle Audits in Cloud gespeichert');
} else {
showInfoModal('‚ùå Fehler beim Speichern in Cloud');
}
});

document.getElementById('desktopToggleHeader').addEventListener('click', toggleDesktopHeader);
document.getElementById('mobileToggleHeader').addEventListener('click', toggleMobileHeader);

syncHeaderData();
}

function setupEventListeners() {
// Audit-Buttons
document.querySelectorAll('.audit-btn').forEach(btn => {
btn.addEventListener('click', function() {
if (this.classList.contains('disabled')) return;
startAudit(this.dataset.audit);
});
});

// Navigation
document.getElementById('employeeListBtn').addEventListener('click', () => {
document.getElementById('auditSelection').classList.remove('active');
document.getElementById('employeeListView').classList.add('active');
document.getElementById('auditContent').classList.remove('active');
});

document.getElementById('backFromEmployeesBtn').addEventListener('click', () => {
document.getElementById('employeeListView').classList.remove('active');
document.getElementById('auditSelection').classList.add('active');
});

// Audit Controls
document.getElementById('backBtn').addEventListener('click', goBackToSelection);
document.getElementById('exportBtn').addEventListener('click', exportAudit);
document.getElementById('reportBtn').addEventListener('click', showReport);
document.getElementById('toggleViewBtn').addEventListener('click', toggleView);
document.getElementById('resetBtn').addEventListener('click', resetAudit);
document.getElementById('uploadQuestionsBtn').addEventListener('click', () => document.getElementById('questionsLoader').click());

// Mitarbeiter Controls
document.getElementById('addEmployeeBtn').addEventListener('click', () => showEmployeeModal());
document.getElementById('refreshAuditsBtn').addEventListener('click', () => {
loadAuditFiles();
renderEmployeeList();
showInfoModal('‚úÖ Audits aktualisiert!');
});
document.getElementById('importEmployeeListBtn').addEventListener('click', () => {
document.getElementById('employeeListLoader').click();
});
document.getElementById('syncCloudBtn').addEventListener('click', async () => {
const choice = await showCustomModal('Cloud-Synchronisation:\n\n1. Hochladen zu Cloud\n2. Herunterladen von Cloud\n\nBitte w√§hlen Sie:');
if (choice === true) {
// Hochladen
await syncAllToCloud();
} else if (choice === false) {
// Herunterladen
await syncFromCloud();
}
});
document.getElementById('employeeListLoader').addEventListener('change', importEmployeeListData);

// Such- und Filterfunktionen
document.getElementById('employeeSearch').addEventListener('input', (e) => {
employeeSearchFilter = e.target.value;
renderEmployeeList();
});
document.getElementById('auditStatusFilter').addEventListener('change', (e) => {
statusFilter = e.target.value;
renderEmployeeList();
});
document.getElementById('glassesFilter').addEventListener('change', (e) => {
glassesFilter = e.target.value;
renderEmployeeList();
});
document.getElementById('clearFiltersBtn').addEventListener('click', () => {
document.getElementById('employeeSearch').value = '';
document.getElementById('auditStatusFilter').value = 'all';
document.getElementById('glassesFilter').value = 'all';
employeeSearchFilter = '';
statusFilter = 'all';
glassesFilter = 'all';
renderEmployeeList();
});

// Datei-Uploads
document.getElementById('fileLoader').addEventListener('change', loadAuditData);
document.getElementById('questionsLoader').addEventListener('change', loadQuestionsData);
document.getElementById('cloudRestoreLoader').addEventListener('change', importEmployeeListData);

// Mobile Navigation
document.getElementById('prevBtn').addEventListener('click', function() {
if (currentMobileQuestion > 0) {
currentMobileQuestion--;
renderMobileQuestion();
window.scrollTo({ top: 0, behavior: 'smooth' });
}
});

document.getElementById('nextBtn').addEventListener('click', function() {
if (currentMobileQuestion < allQuestions.length - 1) {
currentMobileQuestion++;
renderMobileQuestion();
window.scrollTo({ top: 0, behavior: 'smooth' });
}
});

// Resize Handling
window.addEventListener('resize', handleResize);

setupGlobalEventListeners();

// Escape-Key Handling
document.addEventListener('keydown', (e) => {
if (e.key === 'Escape') {
const customModalEl = document.getElementById('customModal');
const employeeModalEl = document.getElementById('employeeModal');
const auditListModalEl = document.getElementById('auditListModal');
const cloudSyncModalEl = document.getElementById('cloudSyncModal');
const reportOverlay = document.getElementById('reportOverlay');
const authorizationOverlay = document.getElementById('authorizationOverlay');
if (customModalEl.style.display === 'flex') {
if (customModalResolve) customModalResolve(false);
closeCustomModal();
}
if (employeeModalEl && employeeModalEl.style.display === 'flex') {
employeeModalEl.style.display = 'none';
}
if (auditListModalEl && auditListModalEl.style.display === 'flex') {
auditListModalEl.style.display = 'none';
currentAuditListEmployeeId = null;
}
if (cloudSyncModalEl && cloudSyncModalEl.style.display === 'flex') {
cloudSyncModalEl.style.display = 'none';
cloudSyncInProgress = false;
}
if (reportOverlay.style.display === 'block') closeReport();
if (authorizationOverlay.style.display === 'block') closeAuthorization();
}
});
}

function setupGlobalEventListeners() {
document.addEventListener('click', function(e) {
if (e.target.closest('.section-header') &&
document.getElementById('desktopView').style.display === 'block') {
const header = e.target.closest('.section-header');
const section = header.closest('.section');

section.classList.toggle('expanded');

const arrow = header.querySelector('span');
if (section.classList.contains('expanded')) {
arrow.style.transform = 'rotate(90deg)';
} else {
arrow.style.transform = 'rotate(0deg)';
}

e.preventDefault();
e.stopPropagation();
}
});

document.addEventListener('click', function(e) {
if (e.target.closest('.verdict-btn')) {
const btn = e.target.closest('.verdict-btn');
const questionElement = btn.closest('.question');
if (!questionElement) return;
const questionId = questionElement.dataset.id;
const verdict = btn.dataset.verdict;

updateQuestionData(questionId, 'verdict', verdict);

questionElement.classList.remove('ok', 'not-ok');
questionElement.classList.add(verdict === 'ok' ? 'ok' : verdict === 'not-ok' ? 'not-ok' : 'not-ok');

questionElement.querySelectorAll('.verdict-btn').forEach(b => b.classList.remove('selected'));
btn.classList.add('selected');

checkAndShowFinalResult();
}
if (e.target.classList.contains('remove-image')) {
const questionId = e.target.dataset.question;
const imageIndex = parseInt(e.target.dataset.index);
const isMobile = window.innerWidth <= 768;
removeImage(questionId, imageIndex, isMobile);
}
});

document.addEventListener('input', function(e) {
if (e.target.classList.contains('comment')) {
const questionId = e.target.closest('.question').dataset.id;
updateQuestionData(questionId, 'comment', e.target.value);
}
if (e.target.classList.contains('header-input')) {
saveCurrentAuditData();
}
});

document.addEventListener('change', function(e) {
if (e.target.classList.contains('image-input')) {
const questionId = e.target.dataset.question;
const isMobile = window.innerWidth <= 768;
handleImageUpload(e, questionId, isMobile);
}
});
}

function printFullReport() {
const reportContainer = document.getElementById('reportContainer');
let printContent = reportContainer.innerHTML;
printContent = printContent.replace(/<div class="report-action-buttons">[\s\S]*?<\/div>/,'');

// PDF-Bericht f√ºr Cloud speichern
saveReportToCloud().then(success => {
if (success) {
console.log('PDF Bericht f√ºr Cloud gespeichert');
}
});

const w=window.open('','_blank');
w.document.write(`<!DOCTYPE html><html><head><title>ZfP Audit Bericht - Schaeffler</title><meta charset="UTF-8"><meta name="viewport" content="width=device-width, initial-scale=1.0"><style>${/iPhone|iPad|iPod/.test(navigator.userAgent)?'html{zoom:0.84;}@page{size:A4 portrait;margin:16mm !important;}':''}
*{margin:0;padding:0;box-sizing:border-box;}
@page{
size:A4 portrait;
margin:12mm !important;
}
body{
font-family:Arial,sans-serif!important;
margin:0!important;padding:0!important;
color:#000!important;font-size:10.5pt!important;
line-height:1.32;
background:#fff!important;
-webkit-print-color-adjust:exact!important;print-color-adjust:exact!important;
position:relative;
min-height:297mm!important;
}
.print-content{
margin:0 auto;padding:0 5mm 15mm 5mm!important;
max-width:180mm;
min-height:calc(297mm - 24mm);
position:relative;
}
.report-header{
border-bottom:1.5px solid #000!important;
padding-bottom:6px;margin-bottom:10px;text-align:center;
}
.report-header h2{font-size:13.5pt;margin:0 0 3px 0;color:#000!important;}
.company-info{font-size:10pt;margin:2px 0;color:#000!important;}
.person-table,.details-table{
width:100%;border-collapse:collapse;margin:8px 0;
font-size:10pt!important;
font-family:Arial,sans-serif!important;
}
.person-table th,.person-table td,.details-table td{
border:1px solid #000!important;padding:5px;vertical-align:top;
font-family:Arial,sans-serif!important;font-size:10pt!important;
}
.person-table th{background:#f0f0f0!important;font-weight:bold;}
.details-table td:first-child{width:25%;background:#f9f9f9!important;}
.results-section{margin:10px 0;}
.report-section-header{
font-size:10.5pt;font-weight:bold;margin:8px 0 4px 0;padding-bottom:2px;border-bottom:1px solid #000;
}
.question-item{
margin:2px 0;padding:3px;font-size:8pt;line-height:1.1;
break-inside:avoid;
page-break-inside:avoid;
}
.question-item.ok{border-left:2px solid #00a000!important;background:#f0fff0!important;}
.question-item.not-ok{border-left:2px solid #ff0000!important;background:#fff0f0!important;}
.question-id{font-weight:bold;}
.question-comment{font-style:italic;color:#555;margin-left:6px;font-size:7.5pt;}
.english-translation{display:none!important;}
.question-item img{
max-width:200px!important;max-height:200px!important;object-fit:contain;display:block;
margin:5px 0;
}
hr{border:none;border-top:1px solid #000;margin:6px 0 8px 0;}
.signature-area{
margin-top:20px;padding-top:10px;border-top:1px solid #000;
display:flex;justify-content:space-between;gap:15px;
page-break-inside:avoid;
}
.signature-box{flex:1;text-align:center;}
.signature-line{margin-top:28px;min-height:28px;height:40px;}

/* FIXED FOOTER ON EVERY PAGE */
.page-footer{
position:absolute!important;
bottom:3mm!important;
left:5mm!important;
right:5mm!important;
padding-top:6px!important;
border-top:0.5px solid #ccc!important;
font-size:7.5pt!important;
color:#444!important;
height:auto!important;
max-height:6mm!important;
background:white!important;
z-index:10!important;
}
.page-footer table{
width:100%!important;border-collapse:collapse!important;
}
.page-footer td{
padding:0 3px!important;margin:0!important;text-align:center!important;
vertical-align:middle!important;background:none!important;
border:none!important;font-size:7.5pt!important;
}
@media print{
html,body{height:auto;margin:0!important;padding:0!important;}
.print-content{margin:0 auto!important;padding:0 5mm 15mm 5mm!important;min-height:282mm!important;}
.page-footer{position:fixed!important;bottom:3mm!important;}
}
</style></head><body><div class="print-content">${printContent}<div class="page-footer">
<table>
<tr>
<td style="text-align: left; width: 33%; font-size: 7.5pt !important;">Daniel H√§usner, WI/SW2-PQT</td>
<td style="text-align: center; width: 34%; font-size: 7.5pt !important;">Schaeffler Technologies AG & Co. KG</td>
<td style="text-align: right; width: 33%; font-size: 7.5pt !important;">Version AB, 29.01.2026</td>
</tr>
</table>
</div></div></body></html>`);
w.document.close();
setTimeout(()=>{ w.focus(); w.print(); setTimeout(()=>{ if(!w.closed) w.close(); },3000); },300);
}

function printFullAuthorization() {
  const authorizationContainer = document.getElementById('authorizationContainer');
  let printContent = authorizationContainer.innerHTML;
  
  // Entferne Action-Buttons
  printContent = printContent.replace(/<div class="report-action-buttons">[\s\S]*?<\/div>/, '');
  
  const w = window.open('', '_blank');
  
  w.document.write(`<!DOCTYPE html>
<html>
<head>
  <title>Autorisierung ZfP - Schaeffler</title>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <style>
    * { margin: 0; padding: 0; box-sizing: border-box; }
    
    @page {
      size: A4 portrait;
      margin: 0 !important;
    }
    
    body {
      font-family: Arial, sans-serif !important;
      margin: 0 !important;
      padding: 0 !important;
      color: #000 !important;
      font-size: 10pt !important;
      line-height: 1.3;
      background: #fff !important;
      -webkit-print-color-adjust: exact !important;
      print-color-adjust: exact !important;
      width: 210mm !important;
      height: 297mm !important;
    }
    
    .print-container {
      width: 210mm !important;
      height: 297mm !important;
      padding: 10mm 15mm !important;
      margin: 0 auto !important;
      position: relative !important;
      box-sizing: border-box !important;
      overflow: visible !important;
    }
    
    .authorization-footer {
      position: fixed !important;
      bottom: 10mm !important;
      left: 15mm !important;
      right: 15mm !important;
      padding-top: 8px !important;
      border-top: 1px solid #ccc !important;
      font-size: 8pt !important;
      color: #666 !important;
      background: white !important;
      z-index: 9999 !important;
    }
    
    h1 {
      font-size: 22pt !important;
      margin: 0 0 5px 0 !important;
      color: #000 !important;
      text-align: center !important;
      font-weight: bold !important;
    }
    
 <!-- DRUCK-OPTIMIERUNG MIT NORMALEN R√ÑNDERN -->
<style>
  @media print {
    .print-container {
      width: 210mm !important;
      height: 297mm !important;
      padding: 15mm 20mm !important;
      margin: 0 !important;
    }
    
    .authorization-footer {
      position: fixed !important;
      bottom: 15mm !important;
      left: 20mm !important;
      right: 20mm !important;
      background: white !important;
      z-index: 9999 !important;
    }
    
    @page {
      size: A4 portrait;
      margin: 15mm !important;
    }
    
    body {
      margin: 0 !important;
      padding: 0 !important;
      width: 210mm !important;
      height: 297mm !important;
    }
  }
</style>
</head>
<body>
  ${printContent}
</body>
</html>`);
  
  w.document.close();
  
  setTimeout(() => {
    w.focus();
    w.print();
    
    setTimeout(() => {
      if (!w.closed) w.close();
    }, 3000);
  }, 250);
}

function toggleDesktopHeader() {
const content = document.getElementById('desktopHeaderContent');
const btn = document.getElementById('desktopToggleHeader');
content.classList.toggle('collapsed');
btn.textContent = content.classList.contains('collapsed') ? 'Einblenden' : 'Ausblenden';
}
function toggleMobileHeader() {
const section = document.getElementById('mobileHeaderSection');
const content = document.getElementById('mobileHeaderContent');
const btn = document.getElementById('mobileToggleHeader');
section.classList.toggle('collapsed');
content.classList.toggle('collapsed');
if (section.classList.contains('collapsed')) {
btn.textContent = 'Einblenden';
section.style.padding = '0';
} else {
btn.textContent = 'Ausblenden';
section.style.padding = '';
}
}

function syncHeaderData() {
const mobileIds = [
'mobileOperatorName', 'mobileOperatorNumber', 'mobileOperatorCert', 'mobileOperatorDept',
'mobileAuditorName', 'mobileAuditorDept', 'mobileAuditorCert', 'mobileAuditorPhone',
'mobileApproverName', 'mobileApproverDept', 'mobileApproverCert', 'mobileApproverPhone',
'mobileReportNumber', 'mobilePartType', 'mobileExternalStandard', 'mobileSStandard', 'mobileWorkInstruction'
];
mobileIds.forEach(mobileId => {
const mobileElement = document.getElementById(mobileId);
if (mobileElement) {
mobileElement.addEventListener('input', function() {
const desktopId = mobileId.replace('mobile', '').charAt(0).toLowerCase() + mobileId.replace('mobile', '').slice(1);
const desktopElement = document.getElementById(desktopId);
if (desktopElement) desktopElement.value = this.value;
saveCurrentAuditData();
});
}
});

const desktopIds = [
'operatorName', 'operatorNumber', 'operatorCert', 'operatorDept',
'auditorName', 'auditorDept', 'auditorCert', 'auditorPhone',
'approverName', 'approverDept', 'approverCert', 'approverPhone',
'reportNumber', 'partType', 'externalStandard', 'sStandard', 'workInstruction'
];
desktopIds.forEach(id => {
const element = document.getElementById(id);
if (element) {
element.addEventListener('input', function() {
const mobileId = 'mobile' + id.charAt(0).toUpperCase() + id.slice(1);
const mobileElement = document.getElementById(mobileId);
if (mobileElement) mobileElement.value = this.value;
saveCurrentAuditData();
});
}
});
}

function resetAllHeaderFields() {
const allIds = [
'operatorName', 'operatorNumber', 'operatorCert', 'operatorDept',
'auditorName', 'auditorDept', 'auditorCert', 'auditorPhone',
'approverName', 'approverDept', 'approverCert', 'approverPhone',
'reportNumber', 'partType', 'externalStandard', 'sStandard', 'workInstruction',
'mobileOperatorName', 'mobileOperatorNumber', 'mobileOperatorCert', 'mobileOperatorDept',
'mobileAuditorName', 'mobileAuditorDept', 'mobileAuditorCert', 'mobileAuditorPhone',
'mobileApproverName', 'mobileApproverDept', 'mobileApproverCert', 'mobileApproverPhone',
'mobileReportNumber', 'mobilePartType', 'mobileExternalStandard', 'mobileSStandard', 'mobileWorkInstruction'
];
allIds.forEach(id => {
const element = document.getElementById(id);
if (element) element.value = '';
});
}

function loadAllAuditData() {
Object.keys(AUDIT_TYPES).forEach(auditType => {
const saved = localStorage.getItem(`zfpAudit_${auditType}`);
if (!saved) {
const sections = STANDARD_QUESTIONS[auditType];
const allQuestionsForAudit = sections.flatMap(section =>
section.questions.map(q => ({
...q,
sectionTitle: section.title,
sectionShort: section.short,
verdict: null,
comment: "",
images: []
}))
);
const initialData = {
meta: {
created: new Date().toISOString(),
lastModified: new Date().toISOString(),
auditType: auditType,
title: AUDIT_TYPES[auditType].title,
version: "2.5",
instanceId: 'AUD-' + Date.now() + '-' + Math.random().toString(36).slice(2,8)
},
headerData: {},
questions: allQuestionsForAudit,
images: {}
};
localStorage.setItem(`zfpAudit_${auditType}`, JSON.stringify(initialData));
}
});
}

function getHeaderData() {
const isMobile = window.innerWidth <= 768;
if (isMobile) {
return {
operatorName: document.getElementById('mobileOperatorName')?.value || '',
operatorNumber: document.getElementById('mobileOperatorNumber')?.value || '',
operatorCert: document.getElementById('mobileOperatorCert')?.value || '',
operatorDept: document.getElementById('mobileOperatorDept')?.value || '',
auditorName: document.getElementById('mobileAuditorName')?.value || '',
auditorDept: document.getElementById('mobileAuditorDept')?.value || '',
auditorCert: document.getElementById('mobileAuditorCert')?.value || '',
auditorPhone: document.getElementById('mobileAuditorPhone')?.value || '',
approverName: document.getElementById('mobileApproverName')?.value || '',
approverDept: document.getElementById('mobileApproverDept')?.value || '',
approverCert: document.getElementById('mobileApproverCert')?.value || '',
approverPhone: document.getElementById('mobileApproverPhone')?.value || '',
reportNumber: document.getElementById('mobileReportNumber')?.value || '',
partType: document.getElementById('mobilePartType')?.value || '',
externalStandard: document.getElementById('mobileExternalStandard')?.value || '',
sStandard: document.getElementById('mobileSStandard')?.value || AUDIT_TYPES[currentAuditType]?.norm || '',
workInstruction: document.getElementById('mobileWorkInstruction')?.value || AUDIT_TYPES[currentAuditType]?.instruction || ''
};
} else {
return {
operatorName: document.getElementById('operatorName')?.value || '',
operatorNumber: document.getElementById('operatorNumber')?.value || '',
operatorCert: document.getElementById('operatorCert')?.value || '',
operatorDept: document.getElementById('operatorDept')?.value || '',
auditorName: document.getElementById('auditorName')?.value || '',
auditorDept: document.getElementById('auditorDept')?.value || '',
auditorCert: document.getElementById('auditorCert')?.value || '',
auditorPhone: document.getElementById('auditorPhone')?.value || '',
approverName: document.getElementById('approverName')?.value || '',
approverDept: document.getElementById('approverDept')?.value || '',
approverCert: document.getElementById('approverCert')?.value || '',
approverPhone: document.getElementById('approverPhone')?.value || '',
reportNumber: document.getElementById('reportNumber')?.value || '',
partType: document.getElementById('partType')?.value || '',
externalStandard: document.getElementById('externalStandard')?.value || '',
sStandard: document.getElementById('sStandard')?.value || AUDIT_TYPES[currentAuditType]?.norm || '',
workInstruction: document.getElementById('workInstruction')?.value || AUDIT_TYPES[currentAuditType]?.instruction || ''
};
}
}

function setHeaderData(data) {
if (!data) return;
const fields = [
{ id: 'operatorName', value: data.operatorName },
{ id: 'operatorNumber', value: data.operatorNumber },
{ id: 'operatorCert', value: data.operatorCert },
{ id: 'operatorDept', value: data.operatorDept },
{ id: 'auditorName', value: data.auditorName },
{ id: 'auditorDept', value: data.auditorDept },
{ id: 'auditorCert', value: data.auditorCert },
{ id: 'auditorPhone', value: data.auditorPhone },
{ id: 'approverName', value: data.approverName },
{ id: 'approverDept', value: data.approverDept },
{ id: 'approverCert', value: data.approverCert },
{ id: 'approverPhone', value: data.approverPhone },
{ id: 'reportNumber', value: data.reportNumber },
{ id: 'partType', value: data.partType },
{ id: 'externalStandard', value: data.externalStandard },
{ id: 'sStandard', value: data.sStandard },
{ id: 'workInstruction', value: data.workInstruction }
];
fields.forEach(field => {
const element = document.getElementById(field.id);
const mobileElement = document.getElementById('mobile' + field.id.charAt(0).toUpperCase() + field.id.slice(1));
if (element && field.value !== undefined) element.value = field.value;
if (mobileElement && field.value !== undefined) mobileElement.value = field.value;
});
}

async function startAudit(auditType) {
currentAuditType = auditType;

document.getElementById('auditSelection').classList.remove('active');
document.getElementById('auditContent').classList.add('active');
document.getElementById('employeeListView').classList.remove('active');
document.getElementById('finalResult').style.display = 'none';

loadCurrentAuditData();

const auditInfo = AUDIT_TYPES[auditType];
document.querySelector('h1').textContent = `ZfP Audit - ${auditInfo.title}`;
document.querySelector('.subtitle').textContent = `Pr√ºfverfahren: ${auditInfo.title}`;

document.getElementById('desktopHeaderContent').classList.remove('collapsed');
document.getElementById('desktopToggleHeader').textContent = 'Ausblenden';
document.getElementById('mobileHeaderSection').classList.add('collapsed');
document.getElementById('mobileHeaderContent').classList.add('collapsed');
document.getElementById('mobileToggleHeader').textContent = 'Einblenden';

const isMobile = window.innerWidth <= 768;
if (isMobile) {
document.getElementById('desktopView').style.display = 'none';
document.getElementById('mobileView').style.display = 'block';
document.getElementById('toggleViewBtn').textContent = 'üñ•Ô∏è Desktop';
renderMobileQuestion();
} else {
document.getElementById('desktopView').style.display = 'block';
document.getElementById('mobileView').style.display = 'none';
document.getElementById('toggleViewBtn').textContent = 'üì± Mobile';
renderAuditSections();
}

updateCurrentAuditProgress();
checkAndShowFinalResult();
}

function loadCurrentAuditData() {
const saved = localStorage.getItem(`zfpAudit_${currentAuditType}`);
if (saved) {
currentAuditData = JSON.parse(saved);
if (!currentAuditData.meta.instanceId) {
currentAuditData.meta.instanceId = 'AUD-' + Date.now() + '-' + Math.random().toString(36).slice(2,8);
localStorage.setItem(`zfpAudit_${currentAuditType}`, JSON.stringify(currentAuditData));
}
allQuestions = currentAuditData.questions || [];
imageStorage = currentAuditData.images || {};

if (currentAuditData.headerData) {
setHeaderData(currentAuditData.headerData);
}

uploadedImages.clear();
allQuestions.forEach(question => {
(question.images || []).forEach(img => uploadedImages.add(img));
});
} else {
const sections = STANDARD_QUESTIONS[currentAuditType];
allQuestions = sections.flatMap(section =>
section.questions.map(q => ({
...q,
sectionTitle: section.title,
sectionShort: section.short,
verdict: null,
comment: "",
images: []
}))
);

currentAuditData = {
meta: {
created: new Date().toISOString(),
lastModified: new Date().toISOString(),
auditType: currentAuditType,
title: AUDIT_TYPES[currentAuditType].title,
version: "2.5",
instanceId: 'AUD-' + Date.now() + '-' + Math.random().toString(36).slice(2,8)
},
headerData: {},
questions: allQuestions,
images: {}
};
}
}

async function saveCurrentAuditData() {
if (!currentAuditType || !currentAuditData) return;

currentAuditData.questions = allQuestions;
currentAuditData.headerData = getHeaderData();
currentAuditData.images = imageStorage;
currentAuditData.meta.lastModified = new Date().toISOString();

if (!currentAuditData.meta.instanceId) {
currentAuditData.meta.instanceId = 'AUD-' + Date.now() + '-' + Math.random().toString(36).slice(2,8);
}

localStorage.setItem(`zfpAudit_${currentAuditType}`, JSON.stringify(currentAuditData));

// SOFORTIGE Cloud-Synchronisation bei √Ñnderung
if (cloudConnected) {
await syncSingleAuditToCloud(currentAuditData);
}

// Auch in Liste speichern
await upsertAuditInList(currentAuditData);

updateAuditProgressDisplays();
updateCurrentAuditProgress();
checkAndShowFinalResult();
}

async function goBackToSelection() {
await saveCurrentAuditData();

const shouldProceed = await showCustomModal('Zur√ºck zur Auswahl? Ungespeicherte √Ñnderungen gehen verloren.');
if (!shouldProceed) return;

currentAuditType = null;
currentAuditData = null;
allQuestions = [];
uploadedImages.clear();

document.getElementById('auditSelection').classList.add('active');
document.getElementById('auditContent').classList.remove('active');
document.getElementById('employeeListView').classList.remove('active');

document.querySelector('h1').textContent = 'ZfP Operator Audit';
document.querySelector('.subtitle').textContent = 'Zerst√∂rungsfreie Pr√ºfverfahren - Operator Qualifizierung';
}

function updateAuditProgressDisplays() {
Object.keys(AUDIT_TYPES).forEach(auditType => {
const progress = calculateAuditProgress(auditType);
const progressElement = document.getElementById(`${auditType}Progress`);
if (progressElement) {
progressElement.textContent = `${progress.percent}%`;
}
});
}

function calculateAuditProgress(auditType) {
const saved = localStorage.getItem(`zfpAudit_${auditType}`);
if (!saved) {
const sections = STANDARD_QUESTIONS[auditType];
const total = sections.reduce((sum, section) => sum + section.questions.length, 0);
return { answered: 0, total, percent: 0, ok: 0, notOk: 0 };
}

const data = JSON.parse(saved);
const questions = data.questions || [];
const total = questions.length;
const answered = questions.filter(q => q.verdict !== null).length;
const ok = questions.filter(q => q.verdict === 'ok').length;
const notOk = questions.filter(q => q.verdict === 'not-ok').length;
const percent = total > 0 ? Math.round((answered / total) * 100) : 0;

return { answered, total, percent, ok, notOk };
}

function updateCurrentAuditProgress() {
if (!allQuestions.length) return;

const total = allQuestions.length;
const answered = allQuestions.filter(q => q.verdict !== null).length;
const ok = allQuestions.filter(q => q.verdict === 'ok').length;
const notOk = allQuestions.filter(q => q.verdict === 'not-ok').length;
const percent = total > 0 ? Math.round((answered / total) * 100) : 0;

document.getElementById('progressFill').style.width = `${percent}%`;
document.getElementById('progressText').textContent = `${percent}%`;

let statusText = "In Bearbeitung";
let statusColor = "#f39c12";

if (answered === total) {
const activityProofQuestion = allQuestions.find(q => q.isActivityProof);
const activityProofOk = activityProofQuestion && activityProofQuestion.verdict === 'ok';

if (notOk === 0 && activityProofOk) {
statusText = "‚úÖ Bestanden";
statusColor = "#27ae60";
} else if (notOk === 0 && !activityProofOk) {
statusText = "‚ö†Ô∏è T√§tigkeitsnachweis fehlt";
statusColor = "#f39c12";
} else {
statusText = "‚ùå Nicht bestanden";
statusColor = "#e74c3c";
}
} else if (answered > 0) {
statusText = `${answered}/${total} beantwortet`;
}

document.getElementById('auditStatusText').textContent = statusText;
document.getElementById('auditStatusText').style.color = statusColor;

if (currentAuditType) {
updateAuditProgressDisplays();
}
}

function renderAuditSections() {
const container = document.getElementById('auditSections');
container.innerHTML = '';

if (!allQuestions.length) return;

const sections = {};
allQuestions.forEach(question => {
if (!sections[question.sectionTitle]) {
sections[question.sectionTitle] = {
title: question.sectionTitle,
short: question.sectionShort,
questions: []
};
}
sections[question.sectionTitle].questions.push(question);
});

Object.values(sections).forEach(section => {
const sectionElement = document.createElement('div');
sectionElement.className = 'section';
sectionElement.innerHTML = `
<div class="section-header">
<h2>${section.title}</h2>
<span>‚ñº</span>
</div>
<div class="section-content">
${renderSectionQuestions(section.questions, false)}
</div>
`;
container.appendChild(sectionElement);
});
}

function renderSectionQuestions(questions, isMobile) {
return questions.map(question => {
const verdict = question.verdict;
const questionClass = verdict === 'ok' ? 'ok' : verdict === 'not-ok' ? 'not-ok' : '';
const images = question.images || [];
const isActivityProof = question.isActivityProof || false;

return `
<div class="question ${questionClass}" data-id="${question.id}">
<div class="question-header">
<div class="question-text">${question.text} ${isActivityProof ? '<span style="color: #e74c3c; font-size: 0.8em;">‚ö†Ô∏è Erforderlich f√ºr Autorisierung</span>' : ''}</div>
<div class="question-id">${question.id}</div>
</div>
${question.english ? `<div class="english-translation">${question.english}</div>` : ''}

<div class="verdict-options">
<button class="verdict-btn ok ${verdict === 'ok' ? 'selected' : ''}" data-verdict="ok">
<span>‚úÖ</span> OK
</button>
<button class="verdict-btn not-ok ${verdict === 'not-ok' ? 'selected' : ''}" data-verdict="not-ok">
<span>‚ùå</span> Nicht OK
</button>
</div>

<div class="comment-section">
<label class="comment-label">Kommentar:</label>
<textarea class="comment" placeholder="Anmerkungen...">${question.comment || ''}</textarea>
</div>

${!isMobile ? `
<div class="image-upload-section">
<h4>üì∏ Bildnachweise (optional)</h4>
<div class="file-input-wrapper">
<input type="file" accept="image/*" class="file-input image-input" multiple data-question="${question.id}">
<span class="file-input-label">Bilder ausw√§hlen</span>
</div>
<div class="image-preview-container" id="preview-${question.id}">
${renderImagePreviews(images, question.id, isMobile)}
</div>
</div>
` : ''}
</div>
`;
}).join('');
}

function renderImagePreviews(images, questionId, isMobile) {
return images.map((img, index) => `
<div class="image-preview-item">
<img class="image-preview" src="${img}" alt="Bild ${index + 1}">
<button class="remove-image" data-question="${questionId}" data-index="${index}">√ó</button>
</div>
`).join('');
}

function renderMobileQuestion() {
if (allQuestions.length === 0) return;

const container = document.getElementById('mobileQuestions');
const question = allQuestions[currentMobileQuestion];
if (!question) return;

const verdict = question.verdict;
const questionClass = verdict === 'ok' ? 'ok' : verdict === 'not-ok' ? 'not-ok' : '';
const images = question.images || [];
const isActivityProof = question.isActivityProof || false;

container.innerHTML = `
<div class="question ${questionClass}" data-id="${question.id}">
<div class="question-header">
<div class="question-text">${question.text} ${isActivityProof ? '<span style="color: #e74c3c; font-size: 0.7em;">‚ö†Ô∏è Erforderlich</span>' : ''}</div>
<div class="question-id">${question.id}</div>
</div>
${question.english ? `<div class="english-translation">${question.english}</div>` : ''}

<div class="verdict-options">
<button class="verdict-btn ok ${verdict === 'ok' ? 'selected' : ''}" data-verdict="ok">
<span>‚úÖ</span> OK
</button>
<button class="verdict-btn not-ok ${verdict === 'not-ok' ? 'selected' : ''}" data-verdict="not-ok">
<span>‚ùå</span> Nicht OK
</button>
</div>

<div class="comment-section">
<label class="comment-label">Kommentar:</label>
<textarea class="comment" placeholder="Anmerkungen..." rows="2">${question.comment || ''}</textarea>
</div>

<div class="image-upload-section">
<h4>üì∏ Bilder (optional)</h4>
<div class="file-input-wrapper">
<input type="file" accept="image/*" class="file-input image-input" multiple data-question="${question.id}">
<span class="file-input-label">Bilder ausw√§hlen</span>
</div>
<div class="image-preview-container" id="mobile_preview-${question.id}">
${renderImagePreviews(images, question.id, true)}
</div>
</div>
</div>
`;

document.getElementById('mobileCounter').textContent = `${currentMobileQuestion + 1}/${allQuestions.length}`;
renderMobileSectionSelector();
}

function renderMobileSectionSelector() {
const container = document.getElementById('sectionSelector');
container.innerHTML = '';

if (!allQuestions.length) return;

const sections = {};
allQuestions.forEach((question, index) => {
if (!sections[question.sectionTitle]) {
sections[question.sectionTitle] = {
title: question.sectionTitle,
short: question.sectionShort,
startIndex: index,
count: 0
};
}
sections[question.sectionTitle].count++;
});

Object.values(sections).forEach(section => {
const button = document.createElement('button');
button.className = 'section-btn';
if (currentMobileQuestion >= section.startIndex &&
currentMobileQuestion < section.startIndex + section.count) {
button.classList.add('active');
}
button.textContent = section.short;
button.title = section.title;
button.addEventListener('click', function() {
currentMobileQuestion = section.startIndex;
renderMobileQuestion();
window.scrollTo({ top: 0, behavior: 'smooth' });
});
container.appendChild(button);
});
}

async function updateQuestionData(questionId, field, value) {
const question = allQuestions.find(q => q.id === questionId);
if (question) {
if (field === 'verdict') {
question.verdict = value;
} else if (field === 'comment') {
question.comment = value;
} else if (field === 'addImage') {
if (!question.images) question.images = [];
if (!uploadedImages.has(value)) {
question.images.push(value);
uploadedImages.add(value);
imageStorage[`${questionId}_${question.images.length}`] = value;
}
} else if (field === 'removeImage') {
if (question.images) {
const removedImage = question.images[value];
question.images.splice(value, 1);
uploadedImages.delete(removedImage);
delete imageStorage[`${questionId}_${value}`];
}
}
await saveCurrentAuditData();
updateCurrentAuditProgress();
}
}

function getDocumentNameForAudit(auditType) {
return 'Schaeffler Technologies AG & Co. KG';
}

function getVersionForAudit(auditType) { return 'Version AB, 29.01.2026'; }

async function processAndLimitImage(file) {
return new Promise((resolve, reject) => {
const maxSize = 5 * 1024 * 1024;
if (file.size > maxSize) {
reject(new Error(`Bild zu gro√ü (${(file.size / 1024 / 1024).toFixed(1)}MB). Max: 5MB`));
return;
}

const img = new Image();
const canvas = document.createElement('canvas');
const ctx = canvas.getContext('2d');

img.onload = function() {
const maxWidth = 1200;
const maxHeight = 800;
let width = img.width;
let height = img.height;

if (width > maxWidth || height > maxHeight) {
const ratio = Math.min(maxWidth / width, maxHeight / height);
width = Math.floor(width * ratio);
height = Math.floor(height * ratio);
}

canvas.width = width;
canvas.height = height;

ctx.fillStyle = 'white';
ctx.fillRect(0, 0, width, height);
ctx.drawImage(img, 0, 0, width, height);

try {
const compressedDataUrl = canvas.toDataURL('image/jpeg', 0.8);
resolve(compressedDataUrl);
} catch (error) {
reject(new Error('Bild konnte nicht verarbeitet werden'));
}
};

img.onerror = function() {
reject(new Error('Bild konnte nicht geladen werden'));
};

img.src = URL.createObjectURL(file);
});
}

async function handleImageUpload(event, questionId, isMobile = false) {
const files = Array.from(event.target.files);
if (!files.length) return;

event.target.value = '';

const question = allQuestions.find(q => q.id === questionId);
if (!question.images) question.images = [];

const previewContainerId = isMobile ? `mobile_preview-${questionId}` : `preview-${questionId}`;
const previewContainer = document.getElementById(previewContainerId);

for (const file of files) {
if (!file.type.startsWith('image/')) {
showCustomModal('‚ùå Nur Bilddateien erlaubt');
continue;
}

try {
const compressedImage = await processAndLimitImage(file);

if (uploadedImages.has(compressedImage)) {
showCustomModal('‚ö†Ô∏è Dieses Bild wurde bereits hochgeladen');
continue;
}

await updateQuestionData(questionId, 'addImage', compressedImage);

const previewItem = document.createElement('div');
previewItem.className = 'image-preview-item';
previewItem.innerHTML = `
<img class="image-preview" src="${compressedImage}" alt="Bild">
<button class="remove-image" data-question="${questionId}" data-index="${question.images.length - 1}">√ó</button>
`;
previewContainer.appendChild(previewItem);

} catch (error) {
showCustomModal(`‚ùå ${error.message}`);
}
}

await saveCurrentAuditData();
}

async function removeImage(questionId, imageIndex, isMobile = false) {
const question = allQuestions.find(q => q.id === questionId);
if (question && question.images) {
await updateQuestionData(questionId, 'removeImage', imageIndex);

if (isMobile) {
renderMobileQuestion();
} else {
const questionElement = document.querySelector(`.question[data-id="${questionId}"]`);
if (questionElement) {
const previewContainer = questionElement.querySelector('.image-preview-container');
if (previewContainer) {
previewContainer.innerHTML = renderImagePreviews(question.images, questionId, false);
}
}
}
}
}

function checkAndShowFinalResult() {
if (!allQuestions.length) return;

const total = allQuestions.length;
const answered = allQuestions.filter(q => q.verdict !== null).length;
const notOk = allQuestions.filter(q => q.verdict === 'not-ok').length;

if (answered === total) {
const finalResult = document.getElementById('finalResult');
const resultIcon = document.getElementById('resultIcon');
const resultText = document.getElementById('resultText');

const activityProofQuestion = allQuestions.find(q => q.isActivityProof);
const activityProofOk = activityProofQuestion && activityProofQuestion.verdict === 'ok';

if (notOk === 0 && activityProofOk) {
finalResult.className = 'final-result passed';
resultIcon.textContent = '‚úÖ';
resultText.textContent = 'Audit BESTANDEN - T√§tigkeitsnachweis vorhanden';
} else if (notOk === 0 && !activityProofOk) {
finalResult.className = 'final-result warning';
resultIcon.textContent = '‚ö†Ô∏è';
resultText.textContent = 'T√§tigkeitsnachweis erforderlich f√ºr Autorisierung';
} else {
finalResult.className = 'final-result failed';
resultIcon.textContent = '‚ùå';
resultText.textContent = 'Audit NICHT BESTANDEN';
}

finalResult.style.display = 'block';
} else {
document.getElementById('finalResult').style.display = 'none';
}
}

async function showReport() {
await saveCurrentAuditData();

const headerData = getHeaderData();
const auditInfo = AUDIT_TYPES[currentAuditType];

let reportHTML = `
<div class="report-header" style="position: relative;">
<div style="position: absolute; top: -5px; right: 1px; text-align: right;">
<img src="https://upload.wikimedia.org/wikipedia/commons/7/72/Schaeffler_logo.svg"
alt="Schaeffler Logo"
style="height: 7mm; width: auto; max-width: 35mm;">
</div>

<h2>ZfP-Operator Audit - ${auditInfo.title}</h2>
<div class="company-info"><strong>Pr√ºfbericht-Nr.:</strong> ${headerData.reportNumber || 'Muster_2025_NE'}</div>
</div>

<table class="person-table">
<thead>
<tr>
<th style="width: 33%;">Bediener / Operator</th>
<th style="width: 33%;">Level II Auditor</th>
<th style="width: 34%;">Freigegeben Stufe III</th>
</tr>
</thead>
<tbody>
<tr>
<td>
<strong>Name:</strong> ${headerData.operatorName || '---'}<br>
<strong>Mitarbeiter-Nr.:</strong> ${headerData.operatorNumber || '---'}<br>
<strong>Zertifikat:</strong> ${headerData.operatorCert || '---'}<br>
<strong>Abteilung:</strong> ${headerData.operatorDept || '---'}
</td>
<td>
<strong>Name:</strong> ${headerData.auditorName || '---'}<br>
<strong>Abteilung:</strong> ${headerData.auditorDept || '---'}<br>
<strong>Zertifikat:</strong> ${headerData.auditorCert || '---'}<br>
<strong>Tel:</strong> ${headerData.auditorPhone || '---'}
</td>
<td>
<strong>Name:</strong> ${headerData.approverName || '---'}<br>
<strong>Abteilung:</strong> ${headerData.approverDept || '---'}<br>
<strong>Zertifikat:</strong> ${headerData.approverCert || '---'}<br>
<strong>Tel:</strong> ${headerData.approverPhone || '---'}
</td>
</tr>
</tbody>
</table>

<table class="details-table">
<tr>
<td><strong>F-Teiletype:</strong></td>
<td style="font-family: Arial, sans-serif; font-size: 10pt;">${headerData.partType || '---'}</td>
<td><strong>Pr√ºfverfahren:</strong></td>
<td style="font-family: Arial, sans-serif; font-size: 10pt;">${auditInfo.title}</td>
</tr>
<tr>
<td><strong>Externe Norm:</strong></td>
<td style="font-family: Arial, sans-serif; font-size: 10pt;">${headerData.externalStandard || '---'}</td>
<td><strong>S-Standard:</strong></td>
<td style="font-family: Arial, sans-serif; font-size: 10pt;">${headerData.sStandard || auditInfo.norm}</td>
</tr>
<tr>
<td><strong>Arbeitsanweisung:</strong></td>
<td colspan="3" style="font-family: Arial, sans-serif; font-size: 10pt;">${headerData.workInstruction || auditInfo.instruction}</td>
</tr>
</table>

<div class="results-section">
<div class="report-section-header">Audit-Ergebnisse</div>
`;

const sections = {};
allQuestions.forEach(question => {
if (!sections[question.sectionTitle]) {
sections[question.sectionTitle] = [];
}
sections[question.sectionTitle].push(question);
});

Object.keys(sections).forEach(sectionTitle => {
reportHTML += `<div class="report-section-header">${sectionTitle}</div>`;

sections[sectionTitle].forEach(question => {
const verdictClass = question.verdict === 'ok' ? 'ok' : question.verdict === 'not-ok' ? 'not-ok' : '';
const verdictIcon = question.verdict === 'ok' ? '‚úÖ' : question.verdict === 'not-ok' ? '‚ùå' : '‚óã';

reportHTML += `
<div class="question-item ${verdictClass}">
<span class="question-id">${question.id}:</span> ${verdictIcon} ${question.text}
${question.comment ? `<div class="question-comment">Kommentar: ${question.comment}</div>` : ''}
${renderQuestionImagesInReport(question)}
</div>`;
});
});

reportHTML += `
</div>

<div class="signature-area">
<div class="signature-box">
<div style="font-weight: bold; font-size: 11px;">Auditor (Level II)</div>
<div class="signature-line"></div>
</div>

<div class="signature-box">
<div style="font-weight: bold; font-size: 11px;">NDT Expert (Level III)</div>
<div class="signature-line"></div>
</div>
</div>

<div style="font-size: 10px; text-align: center; margin-top: 10px;">
<div>Erstellt: ${new Date().toLocaleDateString('de-DE')} ${new Date().toLocaleTimeString('de-DE', {hour: '2-digit', minute:'2-digit'})}</div>
<div>N√§chste Pr√ºfung f√§llig: ${new Date(Date.now() + 365 * 24 * 60 * 60 * 1000).toLocaleDateString('de-DE')}</div>
</div>
`;

document.getElementById('reportContainer').innerHTML = `
<div class="report-action-buttons">
<button class="report-action-btn cloud-btn" onclick="saveReportToCloud()">‚òÅÔ∏è Cloud</button>
<button class="report-action-btn print-btn" onclick="printFullReport()">üñ®Ô∏è</button>
<button class="report-action-btn close-btn" onclick="closeReport()">‚úï</button>
</div>
${reportHTML}
`;
document.getElementById('reportOverlay').style.display = 'block';
document.body.style.overflow = 'hidden';
}

function renderQuestionImagesInReport(question) {
if (!question.images || question.images.length === 0) {
return '';
}
let imagesHTML = '<div style="margin-top: 10px;"><div style="display: flex; flex-wrap: wrap; gap: 15px;">';
question.images.forEach((image) => {
imagesHTML += `
<div style="border: 1px solid #ccc; padding: 5px; background: white; text-align: center;">
<img src="${image}" alt="" style="max-width: 200px; max-height: 200px; object-fit: contain; display: block;">
</div>
`;
});
imagesHTML += '</div></div>';
return imagesHTML;
}

async function resetAudit() {
if (!currentAuditType) return;

const shouldReset = await showCustomModal('Audit wirklich zur√ºcksetzen?\nALLE Daten werden gel√∂scht, inklusive Header-Felder.');
if (!shouldReset) return;

const sections = STANDARD_QUESTIONS[currentAuditType];
allQuestions = sections.flatMap(section =>
section.questions.map(q => ({
...q,
sectionTitle: section.title,
sectionShort: section.short,
verdict: null,
comment: "",
images: []
}))
);

resetAllHeaderFields();

uploadedImages.clear();
imageStorage = {};

currentAuditData = {
meta: {
created: new Date().toISOString(),
lastModified: new Date().toISOString(),
auditType: currentAuditType,
title: AUDIT_TYPES[currentAuditType].title,
version: "2.5",
instanceId: 'AUD-' + Date.now() + '-' + Math.random().toString(36).slice(2,8)
},
headerData: {},
questions: allQuestions,
images: {}
};

localStorage.setItem(`zfpAudit_${currentAuditType}`, JSON.stringify(currentAuditData));

if (window.innerWidth <= 768) {
currentMobileQuestion = 0;
renderMobileQuestion();
} else {
renderAuditSections();
}

updateCurrentAuditProgress();
document.getElementById('finalResult').style.display = 'none';

showCustomModal('‚úÖ Audit wurde zur√ºckgesetzt\nALLE Felder wurden geleert.');
}

async function exportAudit() {
if (!currentAuditType || !currentAuditData) return;

await saveCurrentAuditData();

const exportSnapshot = cloneAuditForExport(currentAuditData);

await upsertAuditInList(exportSnapshot);

ensureEmployeeFromHeader(exportSnapshot.headerData);
loadAuditFiles();
updateEmployeeAudits();
renderEmployeeList();

// Cloud-Speicherung
await syncAllToCloud();
}

function loadAuditFromList(audit) {
if (!audit.meta?.auditType) {
showInfoModal('‚ùå Audit kann nicht geladen werden: Fehlende Typinformation');
return;
}

startAudit(audit.meta.auditType);

currentAuditData = audit;
allQuestions = currentAuditData.questions || [];
imageStorage = currentAuditData.images || {};

uploadedImages.clear();
allQuestions.forEach(q => (q.images || []).forEach(img => uploadedImages.add(img)));

if (currentAuditData.headerData) {
setHeaderData(currentAuditData.headerData);
}

if (!currentAuditData.meta.instanceId) {
currentAuditData.meta.instanceId = 'AUD-' + Date.now() + '-' + Math.random().toString(36).slice(2,8);
}

localStorage.setItem(`zfpAudit_${currentAuditType}`, JSON.stringify(currentAuditData));

if (window.innerWidth <= 768) {
currentMobileQuestion = 0;
renderMobileQuestion();
} else {
renderAuditSections();
}

updateCurrentAuditProgress();
checkAndShowFinalResult();

showInfoModal(`‚úÖ Audit "${audit.info?.title || audit.meta.auditType}" geladen`);
}

function loadAuditData(event) {
const file = event.target.files[0];
if (!file) return;

const reader = new FileReader();
reader.onload = async function(e) {
try {
const loadedData = JSON.parse(e.target.result);

if (!loadedData.meta || !loadedData.meta.auditType) {
throw new Error('Ung√ºltiges Audit-Datenformat');
}

const auditType = loadedData.meta.auditType;

if (currentAuditType !== auditType) {
startAudit(auditType);
}

currentAuditData = loadedData;
allQuestions = currentAuditData.questions || [];
imageStorage = currentAuditData.images || {};

uploadedImages.clear();
allQuestions.forEach(q => (q.images || []).forEach(img => uploadedImages.add(img)));

if (currentAuditData.headerData) {
setHeaderData(currentAuditData.headerData);
}

if (!currentAuditData.meta.instanceId) {
currentAuditData.meta.instanceId = 'AUD-' + Date.now() + '-' + Math.random().toString(36).slice(2,8);
}

localStorage.setItem(`zfpAudit_${auditType}`, JSON.stringify(currentAuditData));

await upsertAuditInList(currentAuditData);

if (window.innerWidth <= 768) { currentMobileQuestion = 0; renderMobileQuestion(); }
else { renderAuditSections(); }

updateCurrentAuditProgress();
checkAndShowFinalResult();

showCustomModal(`‚úÖ Audit geladen\n\n${loadedData.meta.title}\nLetzte √Ñnderung: ${new Date(loadedData.meta.lastModified).toLocaleDateString('de-DE')}`);

} catch (error) {
showCustomModal(`‚ùå Fehler beim Laden: ${error.message}`);
}
};
reader.readAsText(file);
event.target.value = '';
}

async function syncAuditsToCloud() {
if (!cloudConnected) return false;

try {
// Alle lokalen Audits sammeln
const allCloudAudits = [];

Object.keys(AUDIT_TYPES).forEach(auditType => {
const listKey = STORAGE_LIST_KEY(auditType);
const savedList = localStorage.getItem(listKey);
if (savedList) {
try {
const audits = JSON.parse(savedList);
if (Array.isArray(audits)) {
audits.forEach(audit => {
if (audit.meta && audit.headerData) {
allCloudAudits.push({
id: audit.meta.instanceId || `audit_${Date.now()}_${Math.random().toString(36).slice(2,9)}`,
audit_type: auditType,
operator_name: audit.headerData.operatorName || '',
operator_number: audit.headerData.operatorNumber || '',
report_number: audit.headerData.reportNumber || '',
data: audit, // VOLLST√ÑNDIGER AUDIT-INHALT
created_at: audit.meta.created || new Date().toISOString(),
updated_at: new Date().toISOString(),
device_id: 'web_' + navigator.userAgent.substring(0, 30)
});
}
});
}
} catch (e) {
console.error(`Fehler beim Parsen von Audits (${auditType}):`, e);
}
}
});

// Audits in Cloud speichern
for (const audit of allCloudAudits) {
try {
await supabase
.from('zfp_audits')
.upsert(audit, { onConflict: 'id' });
} catch (uploadError) {
console.error(`Upload Fehler f√ºr Audit:`, uploadError);
}
}

return true;
} catch (error) {
console.error('Fehler bei Audit-Sync:', error);
return false;
}
}

function toggleView() {
const desktopView = document.getElementById('desktopView');
const mobileView = document.getElementById('mobileView');
const toggleBtn = document.getElementById('toggleViewBtn');

if (desktopView.style.display === 'block') {
desktopView.style.display = 'none';
mobileView.style.display = 'block';
toggleBtn.textContent = 'üñ•Ô∏è Desktop';
renderMobileQuestion();
} else {
desktopView.style.display = 'block';
mobileView.style.display = 'none';
toggleBtn.textContent = 'üì± Mobile';
renderAuditSections();
}
}

function handleResize() {
const isMobile = window.innerWidth <= 768;
const desktopView = document.getElementById('desktopView');
const mobileView = document.getElementById('mobileView');
const toggleBtn = document.getElementById('toggleViewBtn');

if (isMobile && desktopView.style.display === 'block') {
desktopView.style.display = 'none';
mobileView.style.display = 'block';
toggleBtn.textContent = 'üñ•Ô∏è Desktop';
renderMobileQuestion();
} else if (!isMobile && mobileView.style.display === 'block') {
desktopView.style.display = 'block';
mobileView.style.display = 'none';
toggleBtn.textContent = 'üì± Mobile';
renderAuditSections();
}
}

function loadQuestionsData(event) {
const file = event.target.files[0];
if (!file) return;

const reader = new FileReader();
reader.onload = function(e) {
try {
const questionsData = JSON.parse(e.target.result);

if (typeof questionsData !== 'object') {
throw new Error('Ung√ºltiges Fragenformat');
}

showCustomModal(`‚úÖ Fragen geladen\n\nVerfahren: ${Object.keys(questionsData).join(', ')}`);

} catch (error) {
showCustomModal(`‚ùå Fehler: ${error.message}`);
}
};
reader.readAsText(file);
event.target.value = '';
}

function closeReport() {
document.getElementById('reportOverlay').style.display = 'none';
document.body.style.overflow = 'auto';
}
function closeAuthorization() {
document.getElementById('authorizationOverlay').style.display = 'none';
document.body.style.overflow = 'auto';
}

function showEmployeeModal(editId = null) {
currentEmployeeEditId = editId;
const modal = document.getElementById('employeeModal');
if (editId) {
document.getElementById('employeeModalTitle').textContent = 'Mitarbeiter bearbeiten';
const employee = employees.find(e => e.id === editId);
if (employee) {
document.getElementById('employeeName').value = employee.name || '';
document.getElementById('employeeNumber').value = employee.number || '';
document.getElementById('employeeBirthdate').value = employee.birthdate || '';
document.getElementById('employeeEyeTest').value = employee.eyeTestDate || '';
document.getElementById('employeeCertNumber').value = employee.certNumber || '';
document.getElementById('employeeGlasses').value = employee.glasses || 'unknown';
document.getElementById('employeeDepartment').value = employee.department || '';
document.getElementById('employeeCertificate').value = employee.certificate || '';
document.getElementById('employeeNotes').value = employee.notes || '';
}
} else {
document.getElementById('employeeModalTitle').textContent = 'Mitarbeiter hinzuf√ºgen';
document.getElementById('employeeName').value = '';
document.getElementById('employeeNumber').value = '';
document.getElementById('employeeBirthdate').value = '';
document.getElementById('employeeEyeTest').value = '';
document.getElementById('employeeCertNumber').value = '';
document.getElementById('employeeGlasses').value = 'unknown';
document.getElementById('employeeDepartment').value = '';
document.getElementById('employeeCertificate').value = '';
document.getElementById('employeeNotes').value = '';
}
modal.style.display = 'flex';
}

function editEmployee(id) { showEmployeeModal(id); }

async function deleteEmployee(id) {
employees = employees.filter(e => e.id !== id);
await saveEmployees();
updateEmployeeAudits();
renderEmployeeList();
showInfoModal('‚úÖ Mitarbeiter gel√∂scht!');
}
</script>
</body>
</html>